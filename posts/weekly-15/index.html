<!doctype html><html lang=en><head><meta charset=utf-8><meta name=generator content="Hugo 0.101.0"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Airing"><meta property="og:url" content="https://weekly.ursb.me/posts/weekly-15/"><link rel=canonical href=https://weekly.ursb.me/posts/weekly-15/><link rel=apple-touch-icon href=https://airing.ursb.me/image/favicon.ico><link rel=icon href=https://airing.ursb.me/image/favicon.ico><link rel=shortcut href=https://airing.ursb.me/image/favicon.ico><link rel=alternate type=application/atom+xml href=https://weekly.ursb.me/index.xml title="Airing Weekly"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/weekly.ursb.me\/"},"articleSection":"posts","name":"WJ.15: Chromium Rendering Pipeline - Parsing","headline":"WJ.15: Chromium Rendering Pipeline - Parsing","description":"Warning\n如果您看到本提示，说明该文章目前仍未完成，会不定期迭代更新，该系列文章完成时会合稿发布博客。如果您有任何疑问或反馈，请联系 @airing。Last update: August 21 2022\nPurpose of this document\n本文档系个人研究 Chromium 渲染管线的笔记记录，本文介绍 Chromium 渲染管线的 Parsing 阶段。\n本文分析的源码基于当前最新版本 107，每个版本类名\/函数名和对应的具体实现或许有所差异，但主逻辑目前来看不会有所变动。\n如果你没有看过前文，推荐阅读：\nChromium Rendering Pipeline - Introduce Overview Parsing 的目的是将 HTML 文档解析为 HTML 标准中的 DOM 树结构和 CSSOM 树结构。\n这个环节的核心逻辑是 Render process 接收到网络字节或来自 Service Worker 缓存之后，Parsing HTML 并构建 DOM Tree 和 CSSOM Tree。对于 DOM Tree 的解析，模型如下图所示：\nFigure: The main thread parsing HTML and building a DOM tree Parsing 涉及到的数据流为 bytes → characters → token → nodes → object model，对应到 DOM(document object model) Tree 的构建，如下转换过程所示：","inLanguage":"en-US","author":"Airing","creator":"Airing","publisher":"Airing","accountablePerson":"Airing","copyrightHolder":"Airing","copyrightYear":"2022","datePublished":"2022-08-21 00:00:47 \u002b0800 \u002b0800","dateModified":"2022-08-21 00:00:47 \u002b0800 \u002b0800","url":"https:\/\/weekly.ursb.me\/posts\/weekly-15\/","keywords":[]}</script><title>WJ.15: Chromium Rendering Pipeline - Parsing</title><meta property="og:title" content="WJ.15: Chromium Rendering Pipeline - Parsing"><meta property="og:type" content="article"><meta property="og:description" content="Warning
如果您看到本提示，说明该文章目前仍未完成，会不定期迭代更新，该系列文章完成时会合稿发布博客。如果您有任何疑问或反馈，请联系 @airing。Last update: August 21 2022
Purpose of this document
本文档系个人研究 Chromium 渲染管线的笔记记录，本文介绍 Chromium 渲染管线的 Parsing 阶段。
本文分析的源码基于当前最新版本 107，每个版本类名/函数名和对应的具体实现或许有所差异，但主逻辑目前来看不会有所变动。
如果你没有看过前文，推荐阅读：
Chromium Rendering Pipeline - Introduce Overview Parsing 的目的是将 HTML 文档解析为 HTML 标准中的 DOM 树结构和 CSSOM 树结构。
这个环节的核心逻辑是 Render process 接收到网络字节或来自 Service Worker 缓存之后，Parsing HTML 并构建 DOM Tree 和 CSSOM Tree。对于 DOM Tree 的解析，模型如下图所示：
Figure: The main thread parsing HTML and building a DOM tree Parsing 涉及到的数据流为 bytes → characters → token → nodes → object model，对应到 DOM(document object model) Tree 的构建，如下转换过程所示："><meta name=description content="Warning
如果您看到本提示，说明该文章目前仍未完成，会不定期迭代更新，该系列文章完成时会合稿发布博客。如果您有任何疑问或反馈，请联系 @airing。Last update: August 21 2022
Purpose of this document
本文档系个人研究 Chromium 渲染管线的笔记记录，本文介绍 Chromium 渲染管线的 Parsing 阶段。
本文分析的源码基于当前最新版本 107，每个版本类名/函数名和对应的具体实现或许有所差异，但主逻辑目前来看不会有所变动。
如果你没有看过前文，推荐阅读：
Chromium Rendering Pipeline - Introduce Overview Parsing 的目的是将 HTML 文档解析为 HTML 标准中的 DOM 树结构和 CSSOM 树结构。
这个环节的核心逻辑是 Render process 接收到网络字节或来自 Service Worker 缓存之后，Parsing HTML 并构建 DOM Tree 和 CSSOM Tree。对于 DOM Tree 的解析，模型如下图所示：
Figure: The main thread parsing HTML and building a DOM tree Parsing 涉及到的数据流为 bytes → characters → token → nodes → object model，对应到 DOM(document object model) Tree 的构建，如下转换过程所示："><meta property="og:locale" content="en-us"><meta property="og:image" content="https://airing.ursb.me/image/favicon.ico"><style>body{font-family:bree serif,lxgw wenkai gb,sans-serif;-webkit-font-smoothing:antialiased;margin:0 20px}article{max-width:800px;margin-left:auto;margin-right:auto}a{color:#000;text-decoration:none}a:hover{font-weight:600;text-decoration:underline}.post-ads{margin:50px 0}.markdown-body{font-size:18px;max-width:100%}.markdown-body a{text-decoration:underline;text-decoration-color:#000}.markdown-body blockquote{margin:0;padding:0 1em;color:#57606a;border-left:.25em solid #d0d7de}.markdown-body pre{padding:16px;overflow:auto}.markdown-body code{padding:.2em .4em;font-size:85%;background-color:#f6f8fa;border-radius:6px}.markdown-body pre>code{padding:0;background-color:inherit;border:0;font:14.4px/24px ibm plex mono,Menlo,Consolas,monospace}.Chinese .markdown-body{line-height:200%}.site-date-catalog{font-size:2rem}.header-title{font-size:2rem;font-weight:700;margin-top:32px;font-family:bungee shade,sans-serif}.header-title a{text-decoration:none}.header-subtitle{color:#666}.header-items{margin:10px 0}.header-item{margin:0 5px}.header-line{width:100%;border-width:2px;border-color:#482936;border-style:solid none none none}.lang-switch{font-weight:600}#posts-list{min-height:600px}.posts-line{font-size:1.2rem;margin:12px 0}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{margin-bottom:3px}.site-footer{margin-top:50px}.site-footer-item{margin-right:12px}.post-content img{max-width:100%;display:block;margin-right:auto;margin-top:12px}.post-header{margin-bottom:50px}.post-title{font-size:2rem;font-weight:600}.post-tags{display:inline;font-weight:600;padding:2px 5px;margin-right:6px;border:#000 2px solid;border-radius:5px}.post-date{font-weight:800;font-style:italic}.post-author{float:right;font-weight:600}.page-content{min-height:60%}.post-content{margin-bottom:50px}.post-content p{hyphens:auto;line-height:1.8;text-justify:ideographic;margin-bottom:1em}.related-content{border-width:3px;border-style:solid;border-color:#000;padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:5px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:#fff}@media screen and (max-width:600px){p{word-break:break-all}.header-title,.header-subtitle,.header-items{text-align:center}.posts-line{font-size:16px}.markdown-body{font-size:16px}.post-title{font-size:2rem}.post-content p{letter-spacing:.05em}}@media screen and (max-width:48em){.posts-category{display:none}}.admonition{margin:0 -20px;padding:5px 20px}.admonition .admonition-title{font-weight:700;margin-bottom:0;margin-right:5px;float:left}.admonition.warning{background:#fbe9e7;color:#a30000;margin:0 -20px;padding:5px 20px}.admonition.sourcecode{background:rgba(38,139,210,.1)}.admonition.tryit{background:#b9f6ca}.admonition.tryit .codehilite{background-color:transparent;color:inherit;margin:0}.admonition.tryit .codehilite .c{color:grey}.content{padding-top:20px;width:800px;margin-left:auto;margin-right:auto}.box{width:800px;margin-left:auto;margin-right:auto;margin-top:50px;margin-bottom:50px;padding:20px}.box-centered{text-align:center}.box-white{background:#fff;border:1px solid #ccc;box-shadow:2px 2px 8px #aaa;border-radius:5px}.aside{position:absolute;right:0;top:0;width:240px;text-align:left;font-size:.8em;margin-right:-280px}@media only screen and (max-width:1280px){.box{width:auto;left:0;right:0;margin:0}.box-white{border:none}.content{width:auto;left:0;right:0;margin:0}.aside{margin-right:0;position:relative;right:0;width:auto;font-size:.8em;line-height:1.5em;background-color:rgba(128,128,128,.1);display:block;padding:5px}body{padding:5px}div.codehilite{font:10px/13px ibm plex mono,Menlo,Consolas,monospace;margin:0 -5px;padding:5px}}code{font:14.4px/24px ibm plex mono,Menlo,Consolas,monospace;white-space:pre}.aside code{font:12.96px/21.6px ibm plex mono,Menlo,Consolas,monospace!important}pre{font:16px/24px ibm plex mono,Menlo,Consolas,monospace}div.epigraph blockquote{margin-right:0;float:right;font-style:italic}div.epigraph blockquote .footer{font-style:normal;text-align:right}figure{margin-left:auto;margin-right:auto}figure img{margin-left:auto}figcaption{font-size:.87em;color:#3c40439c;text-align:center}figcaption a{color:#3c40439c}code{text-size-adjust:100%;-ms-text-size-adjust:100%;-moz-text-size-adjust:100%;-webkit-text-size-adjust:100%}</style><style>.highlight{line-height:initial}.highlight pre{--bg:#fff;--fg:#000;--comment:#6a737d;--punctuation:inherit;--operator:inherit;--entity:#6f42c1;--keyword:#d73a49;--variable:#e36209;--string-constant:#032f62;--numeric-constant:#005cc5;padding:1em;background:var(--bg);color:var(--fg)}.highlight pre .p{color:var(--punctuation)}.highlight pre .na,.highlight pre .nb,.highlight pre .nc,.highlight pre .no,.highlight pre .nd,.highlight pre .ni,.highlight pre .ne,.highlight pre .nf,.highlight pre .nl,.highlight pre .nn,.highlight pre .nx,.highlight pre .py,.highlight pre .nt{color:var(--entity)}.highlight pre .vc,.highlight pre .vg,.highlight pre .vi,.highlight pre .nv{color:var(--variable)}.highlight pre .bp{}.highlight pre .o,.highlight pre .ow{color:var(--operator)}.highlight pre .c,.highlight pre .cm,.highlight pre .cp,.highlight pre .c1,.highlight pre .cs{color:var(--comment);font-style:italic}.highlight pre .k,.highlight pre .kc,.highlight pre .kd,.highlight pre .kn,.highlight pre .kp,.highlight pre .kr,.highlight pre .kt{color:var(--keyword);font-weight:500}.highlight pre .s,.highlight pre .sb,.highlight pre .sd,.highlight pre .sc,.highlight pre .s2,.highlight pre .se,.highlight pre .sh,.highlight pre .si,.highlight pre .sx,.highlight pre .sr,.highlight pre .ss,.highlight pre .s1{color:var(--string-constant)}.highlight pre .m,.highlight pre .mi,.highlight pre .mf{color:var(--numeric-constant)}.highlight pre .gi{color:#22863a;background-color:#f0fff4}.highlight pre .gd{color:#b31d28;background-color:#ffeef0}</style><style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:initial;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style><link href=/index.xml rel=alternate type=application/rss+xml title="Airing Weekly"><style>@font-face{font-family:bree serif;font-style:normal;font-weight:400;src:url(https://airing.ursb.me/fonts/BreeSerif-Regular.ttf?max_age=25920000)format('woff2');unicode-range:U+100-24F,U+259,U+1E??,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:bree serif;font-style:normal;font-weight:400;src:url(https://airing.ursb.me/fonts/BreeSerif-Regular.ttf?max_age=25920000)format('woff2');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:lxgw wenkai gb;font-style:normal;font-weight:400;src:url(https://airing.ursb.me/fonts/LXGWWenKaiGB-Regular.ttf?max_age=25920000)format('woff2')}@font-face{font-family:bungee shade;font-style:normal;font-weight:400;src:url(https://airing.ursb.me/fonts/BungeeShade-Regular.ttf?max_age=25920000)format('woff2');unicode-range:U+102-103,U+110-111,U+128-129,U+168-169,U+1A0-1A1,U+1AF-1B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:bungee shade;font-style:normal;font-weight:400;src:url(https://airing.ursb.me/fonts/BungeeShade-Regular.ttf?max_age=25920000)format('woff2');unicode-range:U+100-24F,U+259,U+1E??,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:bungee shade;font-style:normal;font-weight:400;src:url(https://airing.ursb.me/fonts/BungeeShade-Regular.ttf?max_age=25920000)format('woff2');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><article class="post Chinese" id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class=header-title><a href=/>Airing Weekly</a></div><div class=header-subtitle>Log something weekly, want you can be happy.</div></header><div class="row end-md center-xs header-items"><div class=header-item><a href=https://weekly.ursb.me/index.xml target=_blank>RSS</a></div><div class=header-item><a href=https://me.ursb.me/about.html target=_blank>About Me</a></div><div class=header-item><a href=https://github.com/airingursb target=_blank>Github</a></div></div><div class="row end-xs"></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>WJ.15: Chromium Rendering Pipeline - Parsing</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2022-08-21 00:00:47 +0800">21 Aug 2022</time></div><div class=col-xs-6><div class=post-author><a target=_blank href=https://ursb.me>@Airing</a></div></div></div></header><div class="post-content markdown-body"><div class="admonition warning"><p class="first admonition-title">Warning</p><p>如果您看到本提示，说明该文章目前仍未完成，会不定期迭代更新，该系列文章完成时会合稿发布博客。如果您有任何疑问或反馈，请联系 <a href=https://ursb.me>@airing</a>。<strong>Last update: August 21 2022</strong></p></div><div class="admonition sourcecode"><p class="first admonition-title">Purpose of this document</p><p><p>本文档系个人研究 Chromium 渲染管线的笔记记录，本文介绍 Chromium 渲染管线的 Parsing 阶段。</p><p>本文分析的源码基于当前最新版本 <code>107</code>，每个版本类名/函数名和对应的具体实现或许有所差异，但主逻辑目前来看不会有所变动。</p><p>如果你没有看过前文，推荐阅读：</p><ul><li><a href=/posts/weekly-14>Chromium Rendering Pipeline - Introduce</a></li></ul></p></div><h2 id=overview>Overview</h2><p>Parsing 的目的是将 HTML 文档解析为 <a href=https://html.spec.whatwg.org/>HTML 标准</a>中的 DOM 树结构和 CSSOM 树结构。</p><p>这个环节的核心逻辑是 Render process 接收到网络字节或来自 Service Worker 缓存之后，Parsing HTML 并构建 DOM Tree 和 CSSOM Tree。对于 DOM Tree 的解析，模型如下图所示：</p><figure><img src=/images/chromium-rendering-pipeline/bytes-conversion.png alt=/images/chromium-rendering-pipeline/bytes-conversion.png><figcaption><p>Figure: The main thread parsing HTML and building a DOM tree</p></figcaption></figure><p>Parsing 涉及到的数据流为 bytes → characters → token → nodes → object model，对应到 DOM(document object model) Tree 的构建，如下转换过程所示：</p><ol><li>Conversion: HTMLParser 将 bytes 转为 characters</li><li>Tokenizing: 将 characters 转为 W3C 标准的 token</li><li>Lexing: 通过词法分析将 token 转为 Element 对象</li><li>DOM construction: 使用构建好的 Element 对象构建 DOM Tree</li></ol><p>而对于 CSSOM (css object model tree) 规则树的生成也是类型，流程为：</p><ol><li>Conversion</li><li>Tokenizing</li><li>Lexing</li><li>CSSOM construction: 使用构建好的 Node 对象构建 CSSOM Tree</li></ol><p>以下逐步分析 Parsing 的这四个子环节 conversion → tokenizing → Lexing → DOM/CSSOM construction，不过在开始之前先介绍 Loading，了解一下 Document Loader 是如何接收 bytes 的。</p><div class="admonition tryit"><p class="first admonition-title">Read</p><p><p>推荐更多阅读材料：</p><ul><li>DOM 标准：<a href=https://dom.spec.whatwg.org/>https://dom.spec.whatwg.org/</a></li><li>Blink 中的 DOM 实现：<code>renderer/core/dom</code></li></ul></p></div><h2 id=loading>Loading</h2><p>在 <code>HTMLDocumentParser::AppendBytes</code> 断点可以了解 Blink 是如何接收 bytes 的，堆栈如下：</p><pre tabindex=0><code>#0	0x00000002d238276c in blink::HTMLDocumentParser::AppendBytes(char const*, unsigned long) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/parser/html_document_parser.cc:1351
#1	0x00000002d1795144 in blink::DocumentLoader::CommitData(char const*, unsigned long) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/loader/document_loader.cc:1259
#2	0x00000002d1792d0c in blink::DocumentLoader::ProcessDataBuffer(char const*, unsigned long) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/loader/document_loader.cc:1479
#3	0x00000002d1792a54 in blink::DocumentLoader::BodyDataReceived(base::span&lt;char const, 18446744073709551615ul&gt;) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/loader/document_loader.cc:969
#4	0x00000002e17c96a8 in blink::NavigationBodyLoader::ReadFromDataPipe() at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/platform/loader/fetch/url_loader/navigation_body_loader.cc:288
#5	0x00000002e17c80a0 in blink::NavigationBodyLoader::OnReadable(unsigned int) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/platform/loader/fetch/url_loader/navigation_body_loader.cc:244
#6	0x00000002e17c8a94 in blink::NavigationBodyLoader::BindURLLoaderAndStartLoadingResponseBodyIfPossible() at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/platform/loader/fetch/url_loader/navigation_body_loader.cc:349
#7	0x00000002e17c835c in blink::NavigationBodyLoader::StartLoadingBody(blink::WebNavigationBodyLoader::Client*, blink::CodeCacheHost*) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/platform/loader/fetch/url_loader/navigation_body_loader.cc:150
#8	0x00000002d1799a08 in blink::DocumentLoader::StartLoadingBodyWithCodeCache() at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/loader/document_loader.cc:1758
#9	0x00000002d1799018 in blink::DocumentLoader::CreateParserPostCommit() at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/loader/document_loader.cc:2598
#10	0x00000002d1797f0c in blink::DocumentLoader::StartLoadingResponse() at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/loader/document_loader.cc:1662
#11	0x00000002d179e158 in blink::DocumentLoader::CommitNavigation() at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/loader/document_loader.cc:2533
#12	0x00000002d17f08e8 in blink::FrameLoader::CommitDocumentLoader(blink::DocumentLoader*, blink::HistoryItem*, blink::CommitReason) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/loader/frame_loader.cc:1365
#13	0x00000002d17f5980 in blink::FrameLoader::CommitNavigation(std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;, std::Cr::unique_ptr&lt;blink::WebDocumentLoader::ExtraData, std::Cr::default_delete&lt;blink::WebDocumentLoader::ExtraData&gt; &gt;, blink::CommitReason) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/loader/frame_loader.cc:1199
#14	0x00000002d073e558 in blink::WebLocalFrameImpl::CommitNavigation(std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;, std::Cr::unique_ptr&lt;blink::WebDocumentLoader::ExtraData, std::Cr::default_delete&lt;blink::WebDocumentLoader::ExtraData&gt; &gt;) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/frame/web_local_frame_impl.cc:2507
#15	0x000000013a5347f4 in content::RenderFrameImpl::CommitNavigationWithParams(mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;, std::Cr::unique_ptr&lt;content::DocumentState, std::Cr::default_delete&lt;content::DocumentState&gt; &gt;, std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;) at /Users/airing/Files/code/chromium/src/content/renderer/render_frame_impl.cc:2823
#16	0x000000013a580af8 in void base::internal::FunctorTraits&lt;void (content::RenderFrameImpl::*)(mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;, std::Cr::unique_ptr&lt;content::DocumentState, std::Cr::default_delete&lt;content::DocumentState&gt; &gt;, std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;), void&gt;::Invoke&lt;void (content::RenderFrameImpl::*)(mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;, std::Cr::unique_ptr&lt;content::DocumentState, std::Cr::default_delete&lt;content::DocumentState&gt; &gt;, std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;), base::WeakPtr&lt;content::RenderFrameImpl&gt;, mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;, std::Cr::unique_ptr&lt;content::DocumentState, std::Cr::default_delete&lt;content::DocumentState&gt; &gt;, std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt; &gt;(void (content::RenderFrameImpl::*)(mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;, std::Cr::unique_ptr&lt;content::DocumentState, std::Cr::default_delete&lt;content::DocumentState&gt; &gt;, std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;), base::WeakPtr&lt;content::RenderFrameImpl&gt;&amp;&amp;, mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;&amp;&amp;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;&amp;&amp;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;&amp;&amp;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;&amp;&amp;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;&amp;&amp;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;&amp;&amp;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;&amp;&amp;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;&amp;&amp;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;&amp;&amp;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;&amp;&amp;, std::Cr::unique_ptr&lt;content::DocumentState, std::Cr::default_delete&lt;content::DocumentState&gt; &gt;&amp;&amp;, std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;&amp;&amp;) at /Users/airing/Files/code/chromium/src/base/bind_internal.h:562
#17	0x000000013a5805c4 in void base::internal::InvokeHelper&lt;true, void&gt;::MakeItSo&lt;void (content::RenderFrameImpl::*)(mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;, std::Cr::unique_ptr&lt;content::DocumentState, std::Cr::default_delete&lt;content::DocumentState&gt; &gt;, std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;), base::WeakPtr&lt;content::RenderFrameImpl&gt;, mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;, std::Cr::unique_ptr&lt;content::DocumentState, std::Cr::default_delete&lt;content::DocumentState&gt; &gt;, std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt; &gt;(void (content::RenderFrameImpl::*&amp;&amp;)(mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;, std::Cr::unique_ptr&lt;content::DocumentState, std::Cr::default_delete&lt;content::DocumentState&gt; &gt;, std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;), base::WeakPtr&lt;content::RenderFrameImpl&gt;&amp;&amp;, mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;&amp;&amp;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;&amp;&amp;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;&amp;&amp;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;&amp;&amp;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;&amp;&amp;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;&amp;&amp;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;&amp;&amp;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;&amp;&amp;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;&amp;&amp;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;&amp;&amp;, std::Cr::unique_ptr&lt;content::DocumentState, std::Cr::default_delete&lt;content::DocumentState&gt; &gt;&amp;&amp;, std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;&amp;&amp;) at /Users/airing/Files/code/chromium/src/base/bind_internal.h:746
#18	0x000000013a5804d4 in void base::internal::Invoker&lt;base::internal::BindState&lt;void (content::RenderFrameImpl::*)(mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;, std::Cr::unique_ptr&lt;content::DocumentState, std::Cr::default_delete&lt;content::DocumentState&gt; &gt;, std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;), base::WeakPtr&lt;content::RenderFrameImpl&gt;, mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;, std::Cr::unique_ptr&lt;content::DocumentState, std::Cr::default_delete&lt;content::DocumentState&gt; &gt; &gt;, void (std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;)&gt;::RunImpl&lt;void (content::RenderFrameImpl::*)(mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;, std::Cr::unique_ptr&lt;content::DocumentState, std::Cr::default_delete&lt;content::DocumentState&gt; &gt;, std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;), std::Cr::tuple&lt;base::WeakPtr&lt;content::RenderFrameImpl&gt;, mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;, std::Cr::unique_ptr&lt;content::DocumentState, std::Cr::default_delete&lt;content::DocumentState&gt; &gt; &gt;, 0ul, 1ul, 2ul, 3ul, 4ul, 5ul, 6ul, 7ul, 8ul, 9ul, 10ul, 11ul&gt;(void (content::RenderFrameImpl::*&amp;&amp;)(mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;, std::Cr::unique_ptr&lt;content::DocumentState, std::Cr::default_delete&lt;content::DocumentState&gt; &gt;, std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;), std::Cr::tuple&lt;base::WeakPtr&lt;content::RenderFrameImpl&gt;, mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;, std::Cr::unique_ptr&lt;content::DocumentState, std::Cr::default_delete&lt;content::DocumentState&gt; &gt; &gt;&amp;&amp;, std::Cr::integer_sequence&lt;unsigned long, 0ul, 1ul, 2ul, 3ul, 4ul, 5ul, 6ul, 7ul, 8ul, 9ul, 10ul, 11ul&gt;, std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;&amp;&amp;) at /Users/airing/Files/code/chromium/src/base/bind_internal.h:799
#19	0x000000013a580244 in base::internal::Invoker&lt;base::internal::BindState&lt;void (content::RenderFrameImpl::*)(mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;, std::Cr::unique_ptr&lt;content::DocumentState, std::Cr::default_delete&lt;content::DocumentState&gt; &gt;, std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;), base::WeakPtr&lt;content::RenderFrameImpl&gt;, mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;, std::Cr::unique_ptr&lt;content::DocumentState, std::Cr::default_delete&lt;content::DocumentState&gt; &gt; &gt;, void (std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;)&gt;::RunOnce(base::internal::BindStateBase*, std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;&amp;&amp;) at /Users/airing/Files/code/chromium/src/base/bind_internal.h:768
#20	0x000000013a534b30 in base::OnceCallback&lt;void (std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;)&gt;::Run(std::Cr::unique_ptr&lt;blink::WebNavigationParams, std::Cr::default_delete&lt;blink::WebNavigationParams&gt; &gt;) &amp;&amp; at /Users/airing/Files/code/chromium/src/base/callback.h:145
#21	0x000000013a532ebc in content::RenderFrameImpl::CommitNavigation(mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;, mojo::StructPtr&lt;network::mojom::URLResponseHead&gt;, mojo::ScopedHandleBase&lt;mojo::DataPipeConsumerHandle&gt;, mojo::StructPtr&lt;network::mojom::URLLoaderClientEndpoints&gt;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;, base::UnguessableToken const&amp;, std::Cr::vector&lt;blink::ParsedPermissionsPolicyDeclaration, std::Cr::allocator&lt;blink::ParsedPermissionsPolicyDeclaration&gt; &gt; const&amp;, mojo::StructPtr&lt;blink::mojom::PolicyContainer&gt;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;, base::OnceCallback&lt;void (mojo::StructPtr&lt;content::mojom::DidCommitProvisionalLoadParams&gt;, mojo::StructPtr&lt;content::mojom::DidCommitProvisionalLoadInterfaceParams&gt;)&gt;) at /Users/airing/Files/code/chromium/src/content/renderer/render_frame_impl.cc:2723
#22	0x000000013a523260 in content::NavigationClient::CommitNavigation(mojo::StructPtr&lt;blink::mojom::CommonNavigationParams&gt;, mojo::StructPtr&lt;blink::mojom::CommitNavigationParams&gt;, mojo::StructPtr&lt;network::mojom::URLResponseHead&gt;, mojo::ScopedHandleBase&lt;mojo::DataPipeConsumerHandle&gt;, mojo::StructPtr&lt;network::mojom::URLLoaderClientEndpoints&gt;, std::Cr::unique_ptr&lt;blink::PendingURLLoaderFactoryBundle, std::Cr::default_delete&lt;blink::PendingURLLoaderFactoryBundle&gt; &gt;, absl::optional&lt;std::Cr::vector&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt;, std::Cr::allocator&lt;mojo::StructPtr&lt;blink::mojom::TransferrableURLLoader&gt; &gt; &gt; &gt;, mojo::StructPtr&lt;blink::mojom::ControllerServiceWorkerInfo&gt;, mojo::StructPtr&lt;blink::mojom::ServiceWorkerContainerInfoForClient&gt;, mojo::PendingRemote&lt;network::mojom::URLLoaderFactory&gt;, base::UnguessableToken const&amp;, std::Cr::vector&lt;blink::ParsedPermissionsPolicyDeclaration, std::Cr::allocator&lt;blink::ParsedPermissionsPolicyDeclaration&gt; &gt; const&amp;, mojo::StructPtr&lt;blink::mojom::PolicyContainer&gt;, mojo::PendingRemote&lt;blink::mojom::CodeCacheHost&gt;, mojo::StructPtr&lt;content::mojom::CookieManagerInfo&gt;, mojo::StructPtr&lt;content::mojom::StorageInfo&gt;, base::OnceCallback&lt;void (mojo::StructPtr&lt;content::mojom::DidCommitProvisionalLoadParams&gt;, mojo::StructPtr&lt;content::mojom::DidCommitProvisionalLoadInterfaceParams&gt;)&gt;) at /Users/airing/Files/code/chromium/src/content/renderer/navigation_client.cc:53
</code></pre><p style=position:relative><span class=aside>关于 Mojo 的介绍可见本文文末最后一个章节。<br><code>DocumentLoader</code> 的缓冲区使用 <code>data_buffer_</code> 成员变量存储，只有一些特殊情况会用到缓存区逻辑，如 FTP、mhtml 解析等。</span></p><p>Browser process 一边下载网页的内容，一边将下载回来的网页交给 Render process 的 Content 模块，<code>content::</code> 中使用 Mojo 从 Browser process 向 Renderer process 发送 network 线程的数据，而 <code>blink::NavigationBodyLoader</code> 会绑定 Mojo Data Pipe 接收 Content 模块传递过来的网页内容，之后交由 <code>blink::DocumentLoader</code> 做缓冲处理，<code>DocumentLoader</code> 最后会将缓冲区的 bytes 提交给 <code>HTMLDocumentParser</code> 做解析处理。</p><figure><img src=/images/chromium-rendering-pipeline/loading.png alt=/images/chromium-rendering-pipeline/loading.png><figcaption><p>Figure: IPC between the browser and the renderer processes, requesting to render the page</p></figcaption></figure><p style=position:relative><span class=aside>Conversion: bytes → characters</span></p><h2 id=conversion>Conversion</h2><p>根据编码格式做 Decode 处理，我们从 <code>HTMLDocumentParser::AppendBytes</code> 往下，最后走到 <code>HTMLDocumentParser::Append</code> 发现它的参数列表已经是 <code>WTF::String</code> 了，那么 Conversion 就是这两个函数中间堆栈做的事情，断点堆栈如下所示：</p><pre tabindex=0><code>#0	0x00000002d2380488 in blink::HTMLDocumentParser::Append(WTF::String const&amp;) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/parser/html_document_parser.cc:1037
#1	0x00000002cfec278c in blink::DecodedDataDocumentParser::UpdateDocument(WTF::String&amp;) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/dom/decoded_data_document_parser.cc:98
#2	0x00000002cfec268c in blink::DecodedDataDocumentParser::AppendBytes(char const*, unsigned long) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/dom/decoded_data_document_parser.cc:71
#3	0x00000002d2382778 in blink::HTMLDocumentParser::AppendBytes(char const*, unsigned long) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/parser/html_document_parser.cc:1351
</code></pre><p><code>HTMLDocumentParser::AppendBytes</code> 会检查入参数据和当前是否为主线程，之后调用 <code>DecodedDataDocumentParser</code> 下的成员函数 <code>AppendBytes</code>。</p><div class="admonition sourcecode"><p class="first admonition-title">Source Code</p><p><p>HTMLDocumentParser::AppendBytes</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#a90d91>void</span> <span style=color:#000>HTMLDocumentParser</span><span style=color:#000>::</span><span style=color:#000>AppendBytes</span>(<span style=color:#a90d91>const</span> <span style=color:#a90d91>char</span><span style=color:#000>*</span> <span style=color:#000>data</span>, <span style=color:#000>size_t</span> <span style=color:#000>length</span>) {
</span></span><span style=display:flex><span>  <span style=color:#000>TRACE_EVENT2</span>(<span style=color:#c41a16>&#34;blink&#34;</span>, <span style=color:#c41a16>&#34;HTMLDocumentParser::appendBytes&#34;</span>, <span style=color:#c41a16>&#34;size&#34;</span>,
</span></span><span style=display:flex><span>               (<span style=color:#a90d91>unsigned</span>)<span style=color:#000>length</span>, <span style=color:#c41a16>&#34;parser&#34;</span>, (<span style=color:#a90d91>void</span><span style=color:#000>*</span>)<span style=color:#a90d91>this</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>DCHECK</span>(<span style=color:#000>Thread</span><span style=color:#000>::</span><span style=color:#000>MainThread</span>()<span style=color:#000>-&gt;</span><span style=color:#000>IsCurrentThread</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>!</span><span style=color:#000>length</span> <span style=color:#000>||</span> <span style=color:#000>IsStopped</span>())
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>DecodedDataDocumentParser</span><span style=color:#000>::</span><span style=color:#000>AppendBytes</span>(<span style=color:#000>data</span>, <span style=color:#000>length</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></p></div><p>DecodedDataDocumentParser 类的成员变量 <code>decoder_</code> 指向一个 TextResourceDecoder 对象，这个TextResourceDecoder 对象负责对下载回来的网页数据进行解码(<code>TextResourceDecoder::Decode</code>)，解码后得到网页数据的字符串表示，这个字符串将会交给由另外一个成员函数 UpdateDocument 进行处理。</p><div class="admonition sourcecode"><p class="first admonition-title">Source Code</p><p><p>DecodedDataDocumentParser::AppendBytes</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#a90d91>void</span> <span style=color:#000>DecodedDataDocumentParser</span><span style=color:#000>::</span><span style=color:#000>AppendBytes</span>(<span style=color:#a90d91>const</span> <span style=color:#a90d91>char</span><span style=color:#000>*</span> <span style=color:#000>data</span>, <span style=color:#000>size_t</span> <span style=color:#000>length</span>) {
</span></span><span style=display:flex><span>  <span style=color:#177500>// ...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#000>String</span> <span style=color:#000>decoded</span> <span style=color:#000>=</span> <span style=color:#000>decoder_</span><span style=color:#000>-&gt;</span><span style=color:#000>Decode</span>(<span style=color:#000>data</span>, <span style=color:#000>length</span>);
</span></span><span style=display:flex><span>  <span style=color:#000>UpdateDocument</span>(<span style=color:#000>decoded</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></p></div><div class="admonition sourcecode"><p class="first admonition-title">Source Code</p><p><p>DecodedDataDocumentParser::UpdateDocument</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#a90d91>void</span> <span style=color:#000>DecodedDataDocumentParser</span><span style=color:#000>::</span><span style=color:#000>UpdateDocument</span>(<span style=color:#000>String</span><span style=color:#000>&amp;</span> <span style=color:#000>decoded_data</span>) {
</span></span><span style=display:flex><span>  <span style=color:#177500>// A Document created from XSLT may have changed the encoding of the data
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#177500>// before feeding it to the parser, so don&#39;t overwrite the encoding data XSLT
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#177500>// provided about the original encoding.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#a90d91>if</span> (<span style=color:#000>!</span><span style=color:#000>DocumentXSLT</span><span style=color:#000>::</span><span style=color:#000>HasTransformSourceDocument</span>(<span style=color:#000>*</span><span style=color:#000>GetDocument</span>()))
</span></span><span style=display:flex><span>    <span style=color:#000>GetDocument</span>()<span style=color:#000>-&gt;</span><span style=color:#000>SetEncodingData</span>(<span style=color:#000>DocumentEncodingData</span>(<span style=color:#000>*</span><span style=color:#000>decoder_</span>.<span style=color:#000>get</span>()));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>!</span><span style=color:#000>decoded_data</span>.<span style=color:#000>IsEmpty</span>())
</span></span><span style=display:flex><span>    <span style=color:#000>Append</span>(<span style=color:#000>decoded_data</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></p></div><p>最后将解析后的数据交给 <code>HTMLDocumentParser::Append</code> 处理，至此完成了 bytes → characters 的转换，接下来便是解析 token。</p><p style=position:relative><span class=aside>Tokenizing: characters → token</span></p><h2 id=tokenizing>Tokenizing</h2><p style=position:relative><span class=aside>HTMLInputStream input_</span></p><p>接上节所述，调用栈到了 <code>HTMLDocumentParser::Append</code>，该方法首先将 characters 附加在成员变量 <code>input_</code> 描述的一个输入流中，接下来再调用 <code>PumpTokenizerIfPossible</code> 对该输入流 <code>input_</code> 中的 characters 进行解析。</p><div class="admonition sourcecode"><p class="first admonition-title">Source Code</p><p><p>HTMLDocumentParser::Append</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#a90d91>void</span> <span style=color:#000>HTMLDocumentParser</span><span style=color:#000>::</span><span style=color:#000>Append</span>(<span style=color:#a90d91>const</span> <span style=color:#000>String</span><span style=color:#000>&amp;</span> <span style=color:#000>input_source</span>) {
</span></span><span style=display:flex><span>  <span style=color:#000>TRACE_EVENT2</span>(<span style=color:#c41a16>&#34;blink&#34;</span>, <span style=color:#c41a16>&#34;HTMLDocumentParser::append&#34;</span>, <span style=color:#c41a16>&#34;size&#34;</span>,
</span></span><span style=display:flex><span>               <span style=color:#000>input_source</span>.<span style=color:#000>length</span>(), <span style=color:#c41a16>&#34;parser&#34;</span>, (<span style=color:#a90d91>void</span><span style=color:#000>*</span>)<span style=color:#a90d91>this</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>IsStopped</span>())
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>const</span> <span style=color:#000>SegmentedString</span> <span style=color:#000>source</span>(<span style=color:#000>input_source</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>ScanInBackground</span>(<span style=color:#000>input_source</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>!</span><span style=color:#000>background_scanner_</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>!</span><span style=color:#000>preload_scanner_</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>preloader_</span> <span style=color:#000>&amp;&amp;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>GetDocument</span>()<span style=color:#000>-&gt;</span><span style=color:#000>Url</span>().<span style=color:#000>IsValid</span>() <span style=color:#000>&amp;&amp;</span>
</span></span><span style=display:flex><span>      (<span style=color:#000>!</span><span style=color:#000>task_runner_state_</span><span style=color:#000>-&gt;</span><span style=color:#000>IsSynchronous</span>() <span style=color:#000>||</span>
</span></span><span style=display:flex><span>       <span style=color:#000>GetDocument</span>()<span style=color:#000>-&gt;</span><span style=color:#000>IsPrefetchOnly</span>() <span style=color:#000>||</span> <span style=color:#000>IsPaused</span>())) {
</span></span><span style=display:flex><span>    <span style=color:#177500>// If we&#39;re operating with a budget, we need to create a preload scanner to
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// make sure that parser-blocking Javascript requests are dispatched in
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// plenty of time, which prevents unnecessary delays.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// When parsing without a budget (e.g. for HTML fragment parsing), it&#39;s
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// additional overhead to scan the string unless the parser&#39;s already
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// paused whilst executing a script.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>preload_scanner_</span> <span style=color:#000>=</span>
</span></span><span style=display:flex><span>        <span style=color:#000>CreatePreloadScanner</span>(<span style=color:#000>TokenPreloadScanner</span><span style=color:#000>::</span><span style=color:#000>ScannerType</span><span style=color:#000>::</span><span style=color:#000>kMainDocument</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>GetDocument</span>()<span style=color:#000>-&gt;</span><span style=color:#000>IsPrefetchOnly</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> (<span style=color:#000>preload_scanner_</span>) {
</span></span><span style=display:flex><span>      <span style=color:#000>preload_scanner_</span><span style=color:#000>-&gt;</span><span style=color:#000>AppendToEnd</span>(<span style=color:#000>source</span>);
</span></span><span style=display:flex><span>      <span style=color:#177500>// TODO(Richard.Townsend@arm.com): add test coverage of this branch.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// The crash in crbug.com/1166786 indicates that text documents are being
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// speculatively prefetched.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>ScanAndPreload</span>(<span style=color:#000>preload_scanner_</span>.<span style=color:#000>get</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// Return after the preload scanner, do not actually parse the document.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>preload_scanner_</span>) {
</span></span><span style=display:flex><span>    <span style=color:#000>preload_scanner_</span><span style=color:#000>-&gt;</span><span style=color:#000>AppendToEnd</span>(<span style=color:#000>source</span>);
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> (<span style=color:#000>task_runner_state_</span><span style=color:#000>-&gt;</span><span style=color:#000>GetMode</span>() <span style=color:#000>==</span> <span style=color:#000>kAllowDeferredParsing</span> <span style=color:#000>&amp;&amp;</span>
</span></span><span style=display:flex><span>        (<span style=color:#000>IsPaused</span>() <span style=color:#000>||</span> <span style=color:#000>!</span><span style=color:#000>task_runner_state_</span><span style=color:#000>-&gt;</span><span style=color:#000>SeenFirstByte</span>())) {
</span></span><span style=display:flex><span>      <span style=color:#177500>// Should scan and preload if the parser&#39;s paused waiting for a resource,
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// or if we&#39;re starting a document for the first time (we want to at least
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// prefetch anything that&#39;s in the &lt;head&gt; section).
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>ScanAndPreload</span>(<span style=color:#000>preload_scanner_</span>.<span style=color:#000>get</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>input_</span>.<span style=color:#000>AppendToEnd</span>(<span style=color:#000>source</span>);
</span></span><span style=display:flex><span>  <span style=color:#000>task_runner_state_</span><span style=color:#000>-&gt;</span><span style=color:#000>MarkSeenFirstByte</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#177500>// Add input_source.length() to &#34;file size&#34; metric.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#a90d91>if</span> (<span style=color:#000>metrics_reporter_</span>)
</span></span><span style=display:flex><span>    <span style=color:#000>metrics_reporter_</span><span style=color:#000>-&gt;</span><span style=color:#000>AddInput</span>(<span style=color:#000>input_source</span>.<span style=color:#000>length</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>task_runner_state_</span><span style=color:#000>-&gt;</span><span style=color:#000>InPumpSession</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#177500>// We&#39;ve gotten data off the network in a nested write. We don&#39;t want to
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// consume any more of the input stream now.  Do not worry.  We&#39;ll consume
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// this data in a less-nested write().
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#177500>// If we are preloading, FinishAppend() will be called later in
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#177500>// CommitPreloadedData().
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#a90d91>if</span> (<span style=color:#000>IsPreloading</span>())
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>FinishAppend</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>void</span> <span style=color:#000>HTMLDocumentParser</span><span style=color:#000>::</span><span style=color:#000>FinishAppend</span>() {
</span></span><span style=display:flex><span>  <span style=color:#177500>// ...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#000>PumpTokenizerIfPossible</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></p></div><p>根据 <code>HTMLDocumentParser::Append</code> 的实现，我们可以发现在这个过程中会处理一些 Preload 的资源进行预请求。网站通常会使用外链资源，比如 img、css 和 JavaScript 资源，这些文件需要从网络或缓存加载。Main thread 在解析构建 DOM 时逐个请求它们，为了加快网站的加载速度，preload scanner 是并发执行的。即如果在 <code>Append</code> 过程中发现有 <code>&lt;img></code> 或 <code>&lt;link></code> 之类的内容，preload scanner(<code>HTMLParserScriptRunner</code>)会直接获取 HTML parser 解析出来的资源地址，并将请求发送到 browser process 中的 network thread 以获取远程的网络资源。</p><figure><img src=/images/chromium-rendering-pipeline/parsing-html.png alt=/images/chromium-rendering-pipeline/parsing-html.png><figcaption><p>Figure: The main thread parsing HTML and building a DOM tree</p></figcaption></figure><p>在 <code>Append</code> 函数的最后会调用成员函数 <code>PumpTokenizerIfPossible</code>，尝试进行 Tokenizing。我们走进 <code>PumpTokenizerIfPossible</code>，先单步断点看看调用栈的情况:</p><pre tabindex=0><code>#0	0x00000002d23dc084 in blink::HTMLTreeBuilder::ProcessToken(blink::AtomicHTMLToken*) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/parser/html_tree_builder.cc:363
#1	0x00000002d23dadc8 in blink::HTMLTreeBuilder::ConstructTree(blink::AtomicHTMLToken*) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/parser/html_tree_builder.cc:329
#2	0x00000002d237eff0 in blink::HTMLDocumentParser::ConstructTreeFromHTMLToken() at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/parser/html_document_parser.cc:954
#3	0x00000002d237d3a0 in blink::HTMLDocumentParser::PumpTokenizer() at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/parser/html_document_parser.cc:837
#4	0x00000002d237b734 in blink::HTMLDocumentParser::PumpTokenizerIfPossible() at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/parser/html_document_parser.cc:703
</code></pre><div class="admonition sourcecode"><p class="first admonition-title">Source Code</p><p><p>HTMLDocumentParser::PumpTokenizerIfPossible</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#a90d91>void</span> <span style=color:#000>HTMLDocumentParser</span><span style=color:#000>::</span><span style=color:#000>PumpTokenizerIfPossible</span>() {
</span></span><span style=display:flex><span>  <span style=color:#000>TRACE_EVENT1</span>(<span style=color:#c41a16>&#34;blink&#34;</span>, <span style=color:#c41a16>&#34;HTMLDocumentParser::PumpTokenizerIfPossible&#34;</span>, <span style=color:#c41a16>&#34;parser&#34;</span>,
</span></span><span style=display:flex><span>               (<span style=color:#a90d91>void</span><span style=color:#000>*</span>)<span style=color:#a90d91>this</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>bool</span> <span style=color:#000>yielded</span> <span style=color:#000>=</span> <span style=color:#a90d91>false</span>;
</span></span><span style=display:flex><span>  <span style=color:#000>CheckIfBlockingStylesheetAdded</span>();
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>!</span><span style=color:#000>IsStopped</span>() <span style=color:#000>&amp;&amp;</span>
</span></span><span style=display:flex><span>      (<span style=color:#000>!</span><span style=color:#000>IsPaused</span>() <span style=color:#000>||</span> <span style=color:#000>task_runner_state_</span><span style=color:#000>-&gt;</span><span style=color:#000>ShouldEndIfDelayed</span>())) {
</span></span><span style=display:flex><span>    <span style=color:#000>yielded</span> <span style=color:#000>=</span> <span style=color:#000>PumpTokenizer</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>yielded</span>) {
</span></span><span style=display:flex><span>    <span style=color:#000>DCHECK</span>(<span style=color:#000>!</span><span style=color:#000>task_runner_state_</span><span style=color:#000>-&gt;</span><span style=color:#000>ShouldComplete</span>());
</span></span><span style=display:flex><span>    <span style=color:#000>SchedulePumpTokenizer</span>();
</span></span><span style=display:flex><span>  } <span style=color:#a90d91>else</span> <span style=color:#000>if</span> (<span style=color:#000>task_runner_state_</span><span style=color:#000>-&gt;</span><span style=color:#000>ShouldAttemptToEndOnEOF</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#177500>// Fall into this branch if ::Finish has been previously called and we&#39;ve
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// just finished asynchronously parsing everything.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>if</span> (<span style=color:#000>metrics_reporter_</span>)
</span></span><span style=display:flex><span>      <span style=color:#000>metrics_reporter_</span><span style=color:#000>-&gt;</span><span style=color:#000>ReportMetricsAtParseEnd</span>();
</span></span><span style=display:flex><span>    <span style=color:#000>AttemptToEnd</span>();
</span></span><span style=display:flex><span>  } <span style=color:#a90d91>else</span> <span style=color:#000>if</span> (<span style=color:#000>task_runner_state_</span><span style=color:#000>-&gt;</span><span style=color:#000>ShouldEndIfDelayed</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#177500>// If we did not exceed the budget or parsed everything there was to
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// parse, check if we should complete the document.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>if</span> (<span style=color:#000>task_runner_state_</span><span style=color:#000>-&gt;</span><span style=color:#000>ShouldComplete</span>() <span style=color:#000>||</span> <span style=color:#000>IsStopped</span>() <span style=color:#000>||</span> <span style=color:#000>IsStopping</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> (<span style=color:#000>metrics_reporter_</span>)
</span></span><span style=display:flex><span>        <span style=color:#000>metrics_reporter_</span><span style=color:#000>-&gt;</span><span style=color:#000>ReportMetricsAtParseEnd</span>();
</span></span><span style=display:flex><span>      <span style=color:#000>EndIfDelayed</span>();
</span></span><span style=display:flex><span>    } <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#000>ScheduleEndIfDelayed</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></p></div><p style=position:relative><span class=aside>因此我们常说 CSS 加载会阻塞渲染。</span></p><p>函数体内的 <code>CheckIfBlockingStylesheetAdded</code> 调用会检查当前是否有 Stylesheet 追加，如果有的话就会阻止继续 parsing。</p><p style=position:relative><span class=aside>task_runner_state 用于追踪 HTML Parser 内部的状态，可以自行阅读 HTMLDocumentParserState 类的实现了解，这里不赘述。</span></p><div class="admonition warning"><p class="first admonition-title">Warning</p><p>需要后续补充 HTMLDocumentParser::SchedulePumpTokenizer 异步解析的相关内容。</p></div><p><code>PumpTokenizerIfPossible</code> 中还存在异步解析的逻辑，逻辑分支较多，但不管怎样都会调用到 <code>HTMLDocumentParser::PumpTokenizer</code> 进行具体的 Tokenizing。</p><div class="admonition sourcecode"><p class="first admonition-title">Source Code</p><p><p>HTMLDocumentParser::PumpTokenizer</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#a90d91>bool</span> <span style=color:#000>HTMLDocumentParser</span><span style=color:#000>::</span><span style=color:#000>PumpTokenizer</span>() {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#177500>// ...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#a90d91>while</span> (<span style=color:#000>!</span><span style=color:#000>should_yield</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> (<span style=color:#000>task_runner_state_</span><span style=color:#000>-&gt;</span><span style=color:#000>ShouldProcessPreloads</span>())
</span></span><span style=display:flex><span>      <span style=color:#000>FlushPendingPreloads</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>const</span> <span style=color:#a90d91>auto</span> <span style=color:#000>next_token_status</span> <span style=color:#000>=</span> <span style=color:#000>CanTakeNextToken</span>();
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> (<span style=color:#000>next_token_status</span> <span style=color:#000>==</span> <span style=color:#000>kNoTokens</span>) {
</span></span><span style=display:flex><span>      <span style=color:#177500>// No tokens left to process in this pump, so break
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>break</span>;
</span></span><span style=display:flex><span>    } <span style=color:#a90d91>else</span> <span style=color:#000>if</span> (<span style=color:#000>next_token_status</span> <span style=color:#000>==</span> <span style=color:#000>kHaveTokensAfterScript</span> <span style=color:#000>&amp;&amp;</span>
</span></span><span style=display:flex><span>               <span style=color:#000>task_runner_state_</span><span style=color:#000>-&gt;</span><span style=color:#000>HaveExitedHeader</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#177500>// Just executed a parser-blocking script in the body. We&#39;d probably like
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// to yield at some point soon, especially if we&#39;re in &#34;extended budget&#34;
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// mode. So reduce the budget back to at most the default.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>budget</span> <span style=color:#000>=</span> <span style=color:#000>std</span><span style=color:#000>::</span><span style=color:#000>min</span>(<span style=color:#000>budget</span>, <span style=color:#000>kDefaultMaxTokenizationBudget</span>);
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> (<span style=color:#000>TimedParserBudgetEnabled</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#000>timed_budget</span> <span style=color:#000>=</span> <span style=color:#000>std</span><span style=color:#000>::</span><span style=color:#000>min</span>(<span style=color:#000>timed_budget</span>, <span style=color:#000>chunk_parsing_timer_</span>.<span style=color:#000>Elapsed</span>() <span style=color:#000>+</span>
</span></span><span style=display:flex><span>                                                  <span style=color:#000>GetDefaultTimedBudget</span>());
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#000>RUNTIME_CALL_TIMER_SCOPE</span>(
</span></span><span style=display:flex><span>          <span style=color:#000>V8PerIsolateData</span><span style=color:#000>::</span><span style=color:#000>MainThreadIsolate</span>(),
</span></span><span style=display:flex><span>          <span style=color:#000>RuntimeCallStats</span><span style=color:#000>::</span><span style=color:#000>CounterId</span><span style=color:#000>::</span><span style=color:#000>kHTMLTokenizerNextToken</span>);
</span></span><span style=display:flex><span>      <span style=color:#a90d91>if</span> (<span style=color:#000>!</span><span style=color:#000>tokenizer_</span><span style=color:#000>-&gt;</span><span style=color:#000>NextToken</span>(<span style=color:#000>input_</span>.<span style=color:#000>Current</span>(), <span style=color:#000>Token</span>()))
</span></span><span style=display:flex><span>        <span style=color:#a90d91>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#000>budget</span><span style=color:#000>--</span>;
</span></span><span style=display:flex><span>      <span style=color:#000>tokens_parsed</span><span style=color:#000>++</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#000>ConstructTreeFromHTMLToken</span>();
</span></span><span style=display:flex><span>    <span style=color:#177500>// ...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  }
</span></span><span style=display:flex><span>  <span style=color:#177500>// ...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>}
</span></span></code></pre></div></p></div><p>这段代码首先 <code>CanTakeNextToken</code> 判断是否能继续获取 token，如果是就调用 <code>NextToken</code> 获取下一个 token，之后调用 <code>ConstructTreeFromHTMLToken</code>。</p><p style=position:relative><span class=aside>CanTakeNextToken 函数内部调用 HasParserBlockingScript 判断当前是否有 JavaScript 脚本，如果有就暂停解析，并调用 RunScriptsForPausedTreeBuilder 在 main thread 优先执行 JavaScript 逻辑。</span></p><p>不过这段代码中，我们先需要注意的是 RUNTIME_CALL_TIMER_SCOPE 这段逻辑，在 parse 的过程中如果遇到 V8 中有 JavaScript 需要运行，或者解析的网页内容超过一定量时，如果当前线程花在解析网页内容的时间超过预设的阀值(<code>TimedParserBudgetEnabled</code>)，那么当前线程就会自动放弃 CPU，通过一个定时器等待一小段时间后再继续解析剩下的网页内容。</p><div class="admonition tryit"><p class="first admonition-title">Note</p><p><p>JavaScript can block the parsing</p><p>当 HTML Parser 解析到 <code>&lt;script></code> 标签时，Parser 会暂停 HTML 解析并优先执行 <code>&lt;script></code> 中的 JavaScript 代码。</p><p>因为 JavaScript 代码逻辑（如 <code>document.write()</code>）可能会改变 DOM 的布局，这就是为什么在继续解析 HTML Document 之前，HTML Parser 必须等待 JavaScript 运行。</p></p></div><p>所以完整的 Parsing 模型应如下所示:</p><figure><img src=/images/chromium-rendering-pipeline/parsing-model-overview.svg alt=/images/chromium-rendering-pipeline/parsing-model-overview.svg height=600><figcaption><p>Figure: Parsing Model Overview</p></figcaption></figure><p>回到 <code>HTMLDocumentParser::PumpTokenizer</code>，我们分析下 <code>NextToken</code> 究竟是如何获取 token 的，这是 Tokenizing 的核心。</p><p style=position:relative><span class=aside>Tokenization 的实现依照 W3C 规范 13.2.5，可阅读了解： <a href=https://html.spec.whatwg.org/#tokenization>https://html.spec.whatwg.org/#tokenization</a></span></p><p><code>NextToken</code> 是 HTMLTokenizer 的对象 <code>tokenizer_</code> 的成员函数，<code>HTMLTokenizer::NextToken</code> 逻辑很简单且冗长(1600行)，根据当前字符判断下个字符是否可能属于某个 token，源码在 third_party/blink/renderer/core/html/parser/html_tokenizer.cc 文件下，可自行阅读。</p><div class="admonition sourcecode"><p class="first admonition-title">Source Code</p><p><p>HTMLTokenizer::NextToken</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#a90d91>bool</span> <span style=color:#000>HTMLTokenizer</span><span style=color:#000>::</span><span style=color:#000>NextToken</span>(<span style=color:#000>SegmentedString</span><span style=color:#000>&amp;</span> <span style=color:#000>source</span>, <span style=color:#000>HTMLToken</span><span style=color:#000>&amp;</span> <span style=color:#000>token</span>) {
</span></span><span style=display:flex><span>    <span style=color:#177500>// ...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>switch</span> (<span style=color:#000>state_</span>) {
</span></span><span style=display:flex><span>        <span style=color:#000>HTML_BEGIN_STATE</span>(<span style=color:#000>kDataState</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> (<span style=color:#000>cc</span> <span style=color:#000>==</span> <span style=color:#2300ce>&#39;&amp;&#39;</span>)
</span></span><span style=display:flex><span>            <span style=color:#000>HTML_ADVANCE_PAST_NON_NEWLINE_TO</span>(<span style=color:#000>kCharacterReferenceInDataState</span>);
</span></span><span style=display:flex><span>        <span style=color:#a90d91>else</span> <span style=color:#000>if</span> (<span style=color:#000>cc</span> <span style=color:#000>==</span> <span style=color:#2300ce>&#39;&lt;&#39;</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> (<span style=color:#000>token_</span><span style=color:#000>-&gt;</span><span style=color:#000>GetType</span>() <span style=color:#000>==</span> <span style=color:#000>HTMLToken</span><span style=color:#000>::</span><span style=color:#000>kCharacter</span>) {
</span></span><span style=display:flex><span>            <span style=color:#177500>// We have a bunch of character tokens queued up that we
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#177500>// are emitting lazily here.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>            <span style=color:#a90d91>return</span> <span style=color:#a90d91>true</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#000>HTML_ADVANCE_PAST_NON_NEWLINE_TO</span>(<span style=color:#000>kTagOpenState</span>);
</span></span><span style=display:flex><span>        } <span style=color:#a90d91>else</span> <span style=color:#000>if</span> (<span style=color:#000>cc</span> <span style=color:#000>==</span> <span style=color:#000>kEndOfFileMarker</span>)
</span></span><span style=display:flex><span>            <span style=color:#a90d91>return</span> <span style=color:#000>EmitEndOfFile</span>(<span style=color:#000>source</span>);
</span></span><span style=display:flex><span>        <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#a90d91>return</span> <span style=color:#000>EmitData</span>(<span style=color:#000>source</span>, <span style=color:#000>cc</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#000>END_STATE</span>()
</span></span><span style=display:flex><span>        <span style=color:#177500>// ...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    }
</span></span><span style=display:flex><span>    <span style=color:#177500>// ...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>}
</span></span></code></pre></div></p></div><p>至此 Tokenizing 逻辑结束，我们获取到了一个个独立的 token。</p><p style=position:relative><span class=aside>Lexing: token → Element</span></p><h2 id=lexing>Lexing</h2><p>在 <code>HTMLDocumentParser::PumpTokenizer</code> 的最后调用了 <code>ConstructTreeFromHTMLToken</code> 来构建 DOM Tree，我们接着看 <code>ConstructTreeFromHTMLToken</code>，源码如下:</p><div class="admonition sourcecode"><p class="first admonition-title">Source Code</p><p><p>HTMLDocumentParser:: ConstructTreeFromHTMLToken</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#a90d91>void</span> <span style=color:#000>HTMLDocumentParser</span><span style=color:#000>::</span><span style=color:#000>ConstructTreeFromHTMLToken</span>() {
</span></span><span style=display:flex><span>  <span style=color:#000>DCHECK</span>(<span style=color:#000>!</span><span style=color:#000>GetDocument</span>()<span style=color:#000>-&gt;</span><span style=color:#000>IsPrefetchOnly</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>AtomicHTMLToken</span> <span style=color:#000>atomic_token</span>(<span style=color:#000>Token</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#177500>// Check whether we&#39;ve exited the header.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#a90d91>if</span> (<span style=color:#000>!</span><span style=color:#000>task_runner_state_</span><span style=color:#000>-&gt;</span><span style=color:#000>HaveExitedHeader</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> (<span style=color:#000>GetDocument</span>()<span style=color:#000>-&gt;</span><span style=color:#000>body</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#000>task_runner_state_</span><span style=color:#000>-&gt;</span><span style=color:#000>SetExitedHeader</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#177500>// We clear the token_ in case ConstructTree() synchronously re-enters the
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#177500>// parser.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#000>Token</span>().<span style=color:#000>Clear</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>tree_builder_</span><span style=color:#000>-&gt;</span><span style=color:#000>ConstructTree</span>(<span style=color:#000>&amp;</span><span style=color:#000>atomic_token</span>);
</span></span><span style=display:flex><span>  <span style=color:#000>CheckIfBlockingStylesheetAdded</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></p></div><p>如果解析完 <code>&lt;head></code> 部分需要修改 <code>task_runner_state_</code> 的状态，之后调用 <code>HTMLTreeBuilder::ConstructTree</code> 并传入解析到的 token。这个过程中依然会调用 <code>CheckIfBlockingStylesheetAdded</code> 检查是否有样式表插入。</p><div class="admonition sourcecode"><p class="first admonition-title">Source Code</p><p><p>HTMLTreeBuilder::ConstructTree</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#a90d91>void</span> <span style=color:#000>HTMLTreeBuilder</span><span style=color:#000>::</span><span style=color:#000>ConstructTree</span>(<span style=color:#000>AtomicHTMLToken</span><span style=color:#000>*</span> <span style=color:#000>token</span>) {
</span></span><span style=display:flex><span>  <span style=color:#000>RUNTIME_CALL_TIMER_SCOPE</span>(<span style=color:#000>V8PerIsolateData</span><span style=color:#000>::</span><span style=color:#000>MainThreadIsolate</span>(),
</span></span><span style=display:flex><span>                           <span style=color:#000>RuntimeCallStats</span><span style=color:#000>::</span><span style=color:#000>CounterId</span><span style=color:#000>::</span><span style=color:#000>kConstructTree</span>);
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>ShouldProcessTokenInForeignContent</span>(<span style=color:#000>token</span>))
</span></span><span style=display:flex><span>    <span style=color:#000>ProcessTokenInForeignContent</span>(<span style=color:#000>token</span>);
</span></span><span style=display:flex><span>  <span style=color:#a90d91>else</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ProcessToken</span>(<span style=color:#000>token</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>parser_</span><span style=color:#000>-&gt;</span><span style=color:#000>IsDetached</span>())
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>bool</span> <span style=color:#000>in_foreign_content</span> <span style=color:#000>=</span> <span style=color:#a90d91>false</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>!</span><span style=color:#000>tree_</span>.<span style=color:#000>IsEmpty</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#000>HTMLStackItem</span><span style=color:#000>*</span> <span style=color:#000>adjusted_current_node</span> <span style=color:#000>=</span> <span style=color:#000>AdjustedCurrentStackItem</span>();
</span></span><span style=display:flex><span>    <span style=color:#000>in_foreign_content</span> <span style=color:#000>=</span>
</span></span><span style=display:flex><span>        <span style=color:#000>!</span><span style=color:#000>adjusted_current_node</span><span style=color:#000>-&gt;</span><span style=color:#000>IsInHTMLNamespace</span>() <span style=color:#000>&amp;&amp;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>!</span><span style=color:#000>HTMLElementStack</span><span style=color:#000>::</span><span style=color:#000>IsHTMLIntegrationPoint</span>(<span style=color:#000>adjusted_current_node</span>) <span style=color:#000>&amp;&amp;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>!</span><span style=color:#000>HTMLElementStack</span><span style=color:#000>::</span><span style=color:#000>IsMathMLTextIntegrationPoint</span>(<span style=color:#000>adjusted_current_node</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>parser_</span><span style=color:#000>-&gt;</span><span style=color:#000>Tokenizer</span>()<span style=color:#000>-&gt;</span><span style=color:#000>SetForceNullCharacterReplacement</span>(
</span></span><span style=display:flex><span>      <span style=color:#000>insertion_mode_</span> <span style=color:#000>==</span> <span style=color:#000>kTextMode</span> <span style=color:#000>||</span> <span style=color:#000>in_foreign_content</span>);
</span></span><span style=display:flex><span>  <span style=color:#000>parser_</span><span style=color:#000>-&gt;</span><span style=color:#000>Tokenizer</span>()<span style=color:#000>-&gt;</span><span style=color:#000>SetShouldAllowCDATA</span>(<span style=color:#000>in_foreign_content</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>tree_</span>.<span style=color:#000>ExecuteQueuedTasks</span>();
</span></span><span style=display:flex><span>  <span style=color:#177500>// We might be detached now.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>}
</span></span></code></pre></div></p></div><p style=position:relative><span class=aside>Foreign Content: 即不是 HTML 标签相关的内容，如 MathML 和 SVG 这种外部标签相关的内容。对应 W3C 规范可查询 <a href=http://www.whatwg.org/specs/web-apps/current-work/multipage/tree-construction.html#tree-construction>http://www.whatwg.org/specs/web-apps/current-work/multipage/tree-construction.html#tree-construction</a></span></p><p><code>HTMLTreeBuilder::ConstructTree</code> 首先调用 <code>ShouldProcessTokenInForeignContent</code> 判断参数 <code>token</code> 描述的 Token 是否为Foreign Content，如果是，就调用 <code>ProcessTokenInForeignContent</code> 对它进行处理，函数内部会判断这些 token 属于什么类型，如注释、开标签、闭标签、内容等，解析完之后生成 Node 并将其推入到 HTMLElementStack 中。在后文另一个分支 <code>ProcessToken</code> 的调用里会介绍 Node 的生成与压栈逻辑，此处不赘述，这部分源码可见：third_party/blink/renderer/core/html/parser/html_tree_builder.cc。</p><p>而如果 <code>token</code> 描述的是一个 HTML 标签相关的内容，那么调用 <code>HTMLTreeBuilder::ProcessToken</code> 对它进行处理，后文着重介绍 <code>ProcessToken</code>。</p><p style=position:relative><span class=aside>HTML 具有很强的健壮性，Lexing 阶段的这个环节遇到异常时会根据规范做对应的异常处理，具体规范可见<a href=https://html.spec.whatwg.org/multipage/parsing.html#an-introduction-to-error-handling-and-strange-cases-in-the-parser>An introduction to error handling and strange cases in the parser - HTML spec</a></span></p><p>我们先回到 <code>HTMLTreeBuilder::ConstructTree</code> 看看后续逻辑，这里的 <code>tree_</code> 是一个 <code>HTMLConstructionSite</code> 类型的成员变量后续分析 DOM Tree 构建的时候再来看它，我们重点先看看 <code>tree_.ExecuteQueuedTasks()</code>。该方法会执行保存在 <code>HTMLConstructionSite</code> 内部的一个事件队列的任务，这些任务都是在 Tokenizing 的过程中添加到事件队列中去的，主要是为了处理在网页中没有正确闭合格式化的 Tag。即在 Lexing 阶段，Parser 保证了 HTML 结构的健壮性。</p><p>接着我们来看 Lexing 的核心函数 <code>HTMLTreeBuilder::ProcessToken</code> 的实现。</p><div class="admonition sourcecode"><p class="first admonition-title">Source Code</p><p><p>HTMLTreeBuilder::ProcessToken</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#a90d91>void</span> <span style=color:#000>HTMLTreeBuilder</span><span style=color:#000>::</span><span style=color:#000>ProcessToken</span>(<span style=color:#000>AtomicHTMLToken</span><span style=color:#000>*</span> <span style=color:#000>token</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetType</span>() <span style=color:#000>==</span> <span style=color:#000>HTMLToken</span><span style=color:#000>::</span><span style=color:#000>kCharacter</span>) {
</span></span><span style=display:flex><span>    <span style=color:#000>ProcessCharacter</span>(<span style=color:#000>token</span>);
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#177500>// Any non-character token needs to cause us to flush any pending text
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#177500>// immediately. NOTE: flush() can cause any queued tasks to execute, possibly
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#177500>// re-entering the parser.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#000>tree_</span>.<span style=color:#000>Flush</span>(<span style=color:#000>kFlushAlways</span>);
</span></span><span style=display:flex><span>  <span style=color:#000>should_skip_leading_newline_</span> <span style=color:#000>=</span> <span style=color:#a90d91>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>switch</span> (<span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetType</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>case</span> <span style=color:#000>HTMLToken</span><span style=color:#000>::</span><span style=color:#000>kUninitialized</span>:
</span></span><span style=display:flex><span>    <span style=color:#a90d91>case</span> <span style=color:#000>HTMLToken</span><span style=color:#000>::</span><span style=color:#000>kCharacter</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>NOTREACHED</span>();
</span></span><span style=display:flex><span>      <span style=color:#a90d91>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#a90d91>case</span> <span style=color:#000>HTMLToken</span><span style=color:#000>::</span><span style=color:#000>DOCTYPE</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>ProcessDoctypeToken</span>(<span style=color:#000>token</span>);
</span></span><span style=display:flex><span>      <span style=color:#a90d91>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#a90d91>case</span> <span style=color:#000>HTMLToken</span><span style=color:#000>::</span><span style=color:#000>kStartTag</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>ProcessStartTag</span>(<span style=color:#000>token</span>);
</span></span><span style=display:flex><span>      <span style=color:#a90d91>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#a90d91>case</span> <span style=color:#000>HTMLToken</span><span style=color:#000>::</span><span style=color:#000>kEndTag</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>ProcessEndTag</span>(<span style=color:#000>token</span>);
</span></span><span style=display:flex><span>      <span style=color:#a90d91>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#a90d91>case</span> <span style=color:#000>HTMLToken</span><span style=color:#000>::</span><span style=color:#000>kComment</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>ProcessComment</span>(<span style=color:#000>token</span>);
</span></span><span style=display:flex><span>      <span style=color:#a90d91>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#a90d91>case</span> <span style=color:#000>HTMLToken</span><span style=color:#000>::</span><span style=color:#000>kEndOfFile</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>ProcessEndOfFile</span>(<span style=color:#000>token</span>);
</span></span><span style=display:flex><span>      <span style=color:#a90d91>break</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></p></div><p>如果 Token 的类型是 <code>HTMLToken::Character</code>，就表示该 Token 代表的是一个普通文本，这些内容不会马上进行处理，而是先调用 <code>ProcessCharacter</code> 将其保存在内部的一个 <code>PendingText</code> 缓冲区中。</p><div class="admonition sourcecode"><p class="first admonition-title">Source Code</p><p><p>HTMLTreeBuilder::ProcessCharacter</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#a90d91>void</span> <span style=color:#000>HTMLTreeBuilder</span><span style=color:#000>::</span><span style=color:#000>ProcessCharacter</span>(<span style=color:#000>AtomicHTMLToken</span><span style=color:#000>*</span> <span style=color:#000>token</span>) {
</span></span><span style=display:flex><span>  <span style=color:#177500>// ...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#000>CharacterTokenBuffer</span> <span style=color:#000>buffer</span>(<span style=color:#000>token</span>);
</span></span><span style=display:flex><span>  <span style=color:#000>ProcessCharacterBuffer</span>(<span style=color:#000>buffer</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></p></div><p>等到遇到下一个要处理的 Token 的类型不是 <code>HTMLToken::Character</code> 时，才会调用 <code>HTMLConstructionSite::Flush</code> 对缓冲区里的 characters 进行处理，它会把这些文本挂载到最近的 DOM 节点下。</p><p style=position:relative><span class=aside>这部分解析遵循 HTML Standard 规范，可自行阅读: <a href=https://html.spec.whatwg.org/multipage/syntax.html>https://html.spec.whatwg.org/multipage/syntax.html</a></span></p><p>而对于非 <code>HTMLToken::Character</code> 类型的 Token，会根据不同类型调用不同函数对 Token 做处理。在处理的过程中，就会使用栈结构存储 Node (HTML Tag)，以便后续构造 DOM Tree —— 例如对于 <code>HTMLToken::StartTag</code> 类型的 Token，就会调用 <code>ProcessStartTag</code> 执行一个压栈操作，而对于<code>HTMLToken::EndTag</code> 类型的 Token，就会调用 <code>ProcessEndTag</code> 执行一个出栈操作。</p><div class="admonition tryit"><p class="first admonition-title">Note</p><p><p>针对如下所示的 DOM Tree</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#000>div</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#000>p</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#000>div</span>&gt;&lt;/<span style=color:#000>div</span>&gt;
</span></span><span style=display:flex><span>  &lt;/<span style=color:#000>p</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#000>span</span>&gt;&lt;/<span style=color:#000>span</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#000>div</span>&gt;
</span></span></code></pre></div><p>各 Node 压榨与出栈流程如下：</p><p><img src=/images/chromium-rendering-pipeline/node-stack.png alt></p></p></div><p>本文具体讲解下压栈流程，先看看 <code>ProcessStartTag</code> 的实现，源码解析 token 会针对不同名字对应到 Tag 做分支处理，每个分支会调用自己的函数做进一步处理，代码比较繁琐有将近千行，我们择取一个分支看看。</p><p style=position:relative><span class=aside>Insertion Mode 是解析 HTML 时的根据所处理的不同内容设置的状态变量，规范可见：<a href=https://html.spec.whatwg.org/multipage/parsing.html#the-insertion-mode>https://html.spec.whatwg.org/multipage/parsing.html#the-insertion-mode</a></span></p><div class="admonition sourcecode"><p class="first admonition-title">Source Code</p><p><p>HTMLTreeBuilder::ProcessStartTag</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#a90d91>void</span> <span style=color:#000>HTMLTreeBuilder</span><span style=color:#000>::</span><span style=color:#000>ProcessStartTag</span>(<span style=color:#000>AtomicHTMLToken</span><span style=color:#000>*</span> <span style=color:#000>token</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a90d91>switch</span> (<span style=color:#000>GetInsertionMode</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#177500>// ...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#a90d91>case</span> <span style=color:#000>kInBodyMode</span>:
</span></span><span style=display:flex><span>      <span style=color:#000>DCHECK_EQ</span>(<span style=color:#000>GetInsertionMode</span>(), <span style=color:#000>kInBodyMode</span>);
</span></span><span style=display:flex><span>      <span style=color:#000>ProcessStartTagForInBody</span>(<span style=color:#000>token</span>);
</span></span><span style=display:flex><span>      <span style=color:#a90d91>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#177500>// ...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  }
</span></span><span style=display:flex><span>  <span style=color:#177500>// ...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>}
</span></span></code></pre></div></p></div><p>当处理到 <code>&lt;body></code> 里面的内容时，Insertion Mode 就设置为 <code>kInBodyMode</code>，命中状态之后进一步执行 <code>ProcessStartTagForInBody</code> 对 tag 做处理。</p><p style=position:relative><span class=aside>这个示例对应的规范可见: <a href="https://html.spec.whatwg.org/multipage/parsing.html#:~:text=An%20start%20tag%20whose%20tag%20name%20is%20one%20of%3A%20%22address%22%2C">https://html.spec.whatwg.org/multipage/parsing.html</a></span></p><p><code>ProcessStartTagForInBody</code> 的源码又是几百行，会判断当前在 <code>&lt;body></code> 内各种的 tag 可能的情况，我们继续择取一个分支看看，假设要处理的是 <code>&lt;body></code> 下的 <code>&lt;div></code>。</p><div class="admonition sourcecode"><p class="first admonition-title">Source Code</p><p><p>HTMLTreeBuilder::ProcessStartTagForInBody</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#a90d91>void</span> <span style=color:#000>HTMLTreeBuilder</span><span style=color:#000>::</span><span style=color:#000>ProcessStartTagForInBody</span>(<span style=color:#000>AtomicHTMLToken</span><span style=color:#000>*</span> <span style=color:#000>token</span>) {
</span></span><span style=display:flex><span>  <span style=color:#177500>// ...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#a90d91>if</span> (<span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kAddressTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kArticleTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kAsideTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kBlockquoteTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kButtonTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kCenterTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kDetailsTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kDialogTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kDirTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kDivTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kDlTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kFieldsetTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kFigcaptionTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kFigureTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kFooterTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kHeaderTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kHgroupTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kListingTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kMainTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kMenuTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kNavTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kOlTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kPreTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kSectionTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kSummaryTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>    <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kUlTag</span>) {
</span></span><span style=display:flex><span>    <span style=color:#000>ProcessFakePEndTagIfPInButtonScope</span>();
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> (<span style=color:#000>tree_</span>.<span style=color:#000>CurrentStackItem</span>()<span style=color:#000>-&gt;</span><span style=color:#000>IsNumberedHeaderElement</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#000>ParseError</span>(<span style=color:#000>token</span>);
</span></span><span style=display:flex><span>      <span style=color:#000>tree_</span>.<span style=color:#000>OpenElements</span>()<span style=color:#000>-&gt;</span><span style=color:#000>Pop</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#000>tree_</span>.<span style=color:#000>InsertHTMLElement</span>(<span style=color:#000>token</span>);
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#177500>// ...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>}
</span></span></code></pre></div></p></div><p style=position:relative><span class=aside>HTMLElementStack 规范可见: <a href=http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#the-stack-of-open-elements>http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#the-stack-of-open-elements</a><br><br>根据 token 创建 element 的规范可见: <a href=https://html.spec.whatwg.org/C/#create-an-element-for-the-token>https://html.spec.whatwg.org/C/#create-an-element-for-the-token</a></span></p><p>核心是传入 <code>&lt;div></code> token 调用 <code>InsertHTMLElement</code>，在该函数内调用 <code>CreateElement</code> 根据 token 创建一个 HTMLElement，之后将其压入 <code>HTMLElementStack</code> 栈中：</p><div class="admonition sourcecode"><p class="first admonition-title">Source Code</p><p><p>HTMLConstructionSite::InsertHTMLElement</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#a90d91>void</span> <span style=color:#000>HTMLConstructionSite</span><span style=color:#000>::</span><span style=color:#000>InsertHTMLElement</span>(<span style=color:#000>AtomicHTMLToken</span><span style=color:#000>*</span> <span style=color:#000>token</span>) {
</span></span><span style=display:flex><span>  <span style=color:#000>Element</span><span style=color:#000>*</span> <span style=color:#000>element</span> <span style=color:#000>=</span> <span style=color:#000>CreateElement</span>(<span style=color:#000>token</span>, <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>xhtmlNamespaceURI</span>);
</span></span><span style=display:flex><span>  <span style=color:#000>AttachLater</span>(<span style=color:#000>CurrentNode</span>(), <span style=color:#000>element</span>);
</span></span><span style=display:flex><span>  <span style=color:#000>open_elements_</span>.<span style=color:#000>Push</span>(<span style=color:#000>HTMLStackItem</span><span style=color:#000>::</span><span style=color:#000>Create</span>(<span style=color:#000>element</span>, <span style=color:#000>token</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>void</span> <span style=color:#000>HTMLConstructionSite</span><span style=color:#000>::</span><span style=color:#000>CreateElement</span>(<span style=color:#000>AtomicHTMLToken</span><span style=color:#000>*</span> <span style=color:#000>token</span>) {
</span></span><span style=display:flex><span>  <span style=color:#000>Element</span><span style=color:#000>*</span> <span style=color:#000>element</span> <span style=color:#000>=</span> <span style=color:#000>CreateElement</span>(<span style=color:#000>token</span>, <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>xhtmlNamespaceURI</span>);
</span></span><span style=display:flex><span>  <span style=color:#000>AttachLater</span>(<span style=color:#000>CurrentNode</span>(), <span style=color:#000>element</span>);
</span></span><span style=display:flex><span>  <span style=color:#000>open_elements_</span>.<span style=color:#000>Push</span>(<span style=color:#000>HTMLStackItem</span><span style=color:#000>::</span><span style=color:#000>Create</span>(<span style=color:#000>element</span>, <span style=color:#000>token</span>));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>HTMLConstructionSite::CreateElement</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#177500>// &#34;create an element for a token&#34;
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>Element</span><span style=color:#000>*</span> <span style=color:#000>HTMLConstructionSite</span><span style=color:#000>::</span><span style=color:#000>CreateElement</span>(
</span></span><span style=display:flex><span>    <span style=color:#000>AtomicHTMLToken</span><span style=color:#000>*</span> <span style=color:#000>token</span>,
</span></span><span style=display:flex><span>    <span style=color:#a90d91>const</span> <span style=color:#000>AtomicString</span><span style=color:#000>&amp;</span> <span style=color:#000>namespace_uri</span>) {
</span></span><span style=display:flex><span>  <span style=color:#177500>// &#34;1. Let document be intended parent&#39;s node document.&#34;
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#000>Document</span><span style=color:#000>&amp;</span> <span style=color:#000>document</span> <span style=color:#000>=</span> <span style=color:#000>OwnerDocumentForCurrentNode</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#177500>// &#34;2. Let local name be the tag name of the token.&#34;
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#000>QualifiedName</span> <span style=color:#000>tag_name</span> <span style=color:#000>=</span>
</span></span><span style=display:flex><span>      ((<span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>IsValidHTMLTag</span>() <span style=color:#000>&amp;&amp;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>namespace_uri</span> <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>xhtmlNamespaceURI</span>)
</span></span><span style=display:flex><span>           <span style=color:#000>?</span> <span style=color:#a90d91>static_cast</span><span style=color:#000>&lt;</span><span style=color:#a90d91>const</span> <span style=color:#000>QualifiedName</span><span style=color:#000>&amp;&gt;</span>(
</span></span><span style=display:flex><span>                 <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>TagToQualifedName</span>(<span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetHTMLTag</span>()))
</span></span><span style=display:flex><span>           <span style=color:#000>:</span> <span style=color:#000>QualifiedName</span>(<span style=color:#000>g_null_atom</span>, <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>(), <span style=color:#000>namespace_uri</span>));
</span></span><span style=display:flex><span>  <span style=color:#177500>// &#34;3. Let is be the value of the &#34;is&#34; attribute in the given token ...&#34; etc.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#a90d91>const</span> <span style=color:#000>Attribute</span><span style=color:#000>*</span> <span style=color:#000>is_attribute</span> <span style=color:#000>=</span> <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetAttributeItem</span>(<span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kIsAttr</span>);
</span></span><span style=display:flex><span>  <span style=color:#a90d91>const</span> <span style=color:#000>AtomicString</span><span style=color:#000>&amp;</span> <span style=color:#000>is</span> <span style=color:#000>=</span> <span style=color:#000>is_attribute</span> <span style=color:#000>?</span> <span style=color:#000>is_attribute</span><span style=color:#000>-&gt;</span><span style=color:#000>Value</span>() <span style=color:#000>:</span> <span style=color:#000>g_null_atom</span>;
</span></span><span style=display:flex><span>  <span style=color:#177500>// &#34;4. Let definition be the result of looking up a custom element ...&#34; etc.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#a90d91>auto</span><span style=color:#000>*</span> <span style=color:#000>definition</span> <span style=color:#000>=</span> <span style=color:#000>LookUpCustomElementDefinition</span>(<span style=color:#000>document</span>, <span style=color:#000>tag_name</span>, <span style=color:#000>is</span>);
</span></span><span style=display:flex><span>  <span style=color:#177500>// &#34;5. If definition is non-null and the parser was not originally created
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#177500>// for the HTML fragment parsing algorithm, then let will execute script
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#177500>// be true.&#34;
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#a90d91>bool</span> <span style=color:#000>will_execute_script</span> <span style=color:#000>=</span> <span style=color:#000>definition</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>!</span><span style=color:#000>is_parsing_fragment_</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>Element</span><span style=color:#000>*</span> <span style=color:#000>element</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> (<span style=color:#000>will_execute_script</span>) {
</span></span><span style=display:flex><span>    <span style=color:#177500>// &#34;6.1 Increment the document&#39;s throw-on-dynamic-insertion counter.&#34;
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>ThrowOnDynamicMarkupInsertionCountIncrementer</span>
</span></span><span style=display:flex><span>        <span style=color:#000>throw_on_dynamic_markup_insertions</span>(<span style=color:#000>&amp;</span><span style=color:#000>document</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// &#34;6.2 If the JavaScript execution context stack is empty,
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// then perform a microtask checkpoint.&#34;
</span></span></span><span style=display:flex><span><span style=color:#177500></span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// TODO(dominicc): This is the way the Blink HTML parser performs
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// checkpoints, but note the spec is different--it talks about the
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// JavaScript stack, not the script nesting level.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>if</span> (<span style=color:#1c01ce>0u</span> <span style=color:#000>==</span> <span style=color:#000>reentry_permit_</span><span style=color:#000>-&gt;</span><span style=color:#000>ScriptNestingLevel</span>())
</span></span><span style=display:flex><span>      <span style=color:#000>Microtask</span><span style=color:#000>::</span><span style=color:#000>PerformCheckpoint</span>(<span style=color:#000>V8PerIsolateData</span><span style=color:#000>::</span><span style=color:#000>MainThreadIsolate</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// &#34;6.3 Push a new element queue onto the custom element
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// reactions stack.&#34;
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>CEReactionsScope</span> <span style=color:#000>reactions</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// &#34;7. Let element be the result of creating an element given document,
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// localName, given namespace, null, and is. If will execute script is true,
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// set the synchronous custom elements flag; otherwise, leave it unset.&#34;
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// TODO(crbug.com/1080673): We clear the CreatedbyParser flag here, so that
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// elements get fully constructed. Some elements (e.g. HTMLInputElement)
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// only partially construct themselves when created by the parser, but since
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// this is a custom element, we need a fully-constructed element here.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>element</span> <span style=color:#000>=</span> <span style=color:#000>definition</span><span style=color:#000>-&gt;</span><span style=color:#000>CreateElement</span>(
</span></span><span style=display:flex><span>        <span style=color:#000>document</span>, <span style=color:#000>tag_name</span>,
</span></span><span style=display:flex><span>        <span style=color:#000>GetCreateElementFlags</span>().<span style=color:#000>SetCreatedByParser</span>(<span style=color:#a90d91>false</span>, <span style=color:#a90d91>nullptr</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// &#34;8. Append each attribute in the given token to element.&#34; We don&#39;t use
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// setAttributes here because the custom element constructor may have
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// manipulated attributes.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>for</span> (<span style=color:#a90d91>const</span> <span style=color:#a90d91>auto</span><span style=color:#000>&amp;</span> <span style=color:#000>attribute</span> : <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>Attributes</span>())
</span></span><span style=display:flex><span>      <span style=color:#000>element</span><span style=color:#000>-&gt;</span><span style=color:#000>setAttribute</span>(<span style=color:#000>attribute</span>.<span style=color:#000>GetName</span>(), <span style=color:#000>attribute</span>.<span style=color:#000>Value</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// &#34;9. If will execute script is true, then ...&#34; etc. The CEReactionsScope
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// and ThrowOnDynamicMarkupInsertionCountIncrementer destructors implement
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// steps 9.1-3.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  } <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> (<span style=color:#000>definition</span>) {
</span></span><span style=display:flex><span>      <span style=color:#000>DCHECK</span>(<span style=color:#000>GetCreateElementFlags</span>().<span style=color:#000>IsAsyncCustomElements</span>());
</span></span><span style=display:flex><span>      <span style=color:#000>element</span> <span style=color:#000>=</span> <span style=color:#000>definition</span><span style=color:#000>-&gt;</span><span style=color:#000>CreateElement</span>(<span style=color:#000>document</span>, <span style=color:#000>tag_name</span>,
</span></span><span style=display:flex><span>                                          <span style=color:#000>GetCreateElementFlags</span>());
</span></span><span style=display:flex><span>    } <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#000>element</span> <span style=color:#000>=</span> <span style=color:#000>CustomElement</span><span style=color:#000>::</span><span style=color:#000>CreateUncustomizedOrUndefinedElement</span>(
</span></span><span style=display:flex><span>          <span style=color:#000>document</span>, <span style=color:#000>tag_name</span>, <span style=color:#000>GetCreateElementFlags</span>(), <span style=color:#000>is</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#177500>// Definition for the created element does not exist here and it cannot be
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// custom, precustomized, or failed.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>DCHECK_NE</span>(<span style=color:#000>element</span><span style=color:#000>-&gt;</span><span style=color:#000>GetCustomElementState</span>(), <span style=color:#000>CustomElementState</span><span style=color:#000>::</span><span style=color:#000>kCustom</span>);
</span></span><span style=display:flex><span>    <span style=color:#000>DCHECK_NE</span>(<span style=color:#000>element</span><span style=color:#000>-&gt;</span><span style=color:#000>GetCustomElementState</span>(),
</span></span><span style=display:flex><span>              <span style=color:#000>CustomElementState</span><span style=color:#000>::</span><span style=color:#000>kPreCustomized</span>);
</span></span><span style=display:flex><span>    <span style=color:#000>DCHECK_NE</span>(<span style=color:#000>element</span><span style=color:#000>-&gt;</span><span style=color:#000>GetCustomElementState</span>(), <span style=color:#000>CustomElementState</span><span style=color:#000>::</span><span style=color:#000>kFailed</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// TODO(dominicc): Move these steps so they happen for custom
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// elements as well as built-in elements when customized built in
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// elements are implemented for resettable, listed elements.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 10. If element has an xmlns attribute in the XMLNS namespace
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// whose value is not exactly the same as the element&#39;s namespace,
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// that is a parse error. Similarly, if element has an xmlns:xlink
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// attribute in the XMLNS namespace whose value is not the XLink
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// Namespace, that is a parse error.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// TODO(dominicc): Implement step 10 when the HTML parser does
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// something useful with parse errors.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 11. If element is a resettable element, invoke its reset
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// algorithm. (This initializes the element&#39;s value and
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// checkedness based on the element&#39;s attributes.)
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// TODO(dominicc): Implement step 11, resettable elements.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 12. If element is a form-associated element, and the form
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// element pointer is not null, and there is no template element
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#177500>// on the stack of open elements, ...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>auto</span><span style=color:#000>*</span> <span style=color:#000>html_element</span> <span style=color:#000>=</span> <span style=color:#000>DynamicTo</span><span style=color:#000>&lt;</span><span style=color:#000>HTMLElement</span><span style=color:#000>&gt;</span>(<span style=color:#000>element</span>);
</span></span><span style=display:flex><span>    <span style=color:#000>FormAssociated</span><span style=color:#000>*</span> <span style=color:#000>form_associated_element</span> <span style=color:#000>=</span>
</span></span><span style=display:flex><span>        <span style=color:#000>html_element</span> <span style=color:#000>?</span> <span style=color:#000>html_element</span><span style=color:#000>-&gt;</span><span style=color:#000>ToFormAssociatedOrNull</span>() <span style=color:#000>:</span> <span style=color:#a90d91>nullptr</span>;
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> (<span style=color:#000>form_associated_element</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>document</span>.<span style=color:#000>GetFrame</span>() <span style=color:#000>&amp;&amp;</span> <span style=color:#000>form_</span>.<span style=color:#000>Get</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#177500>// ... and element is either not listed or doesn&#39;t have a form
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// attribute, and the intended parent is in the same tree as the
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// element pointed to by the form element pointer , associate
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// element with the form element pointed to by the form element
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// pointer , and suppress the running of the reset the form owner
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// algorithm when the parser subsequently attempts to insert the
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// element.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>
</span></span><span style=display:flex><span>      <span style=color:#177500>// TODO(dominicc): There are many differences to the spec here;
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// some of them are observable:
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>//
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// - The HTML spec tracks whether there is a template element on
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// the stack both for manipulating the form element pointer 
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>//   and using it here.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// - FormAssociated::AssociateWith implementations don&#39;t do the
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>//   &#34;same tree&#34; check; for example
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>//   HTMLImageElement::AssociateWith just checks whether the form
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>//   is in *a* tree. This check should be done here consistently.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>// - ListedElement is a mixin; add IsListedElement and skip
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>//   setting the form for listed attributes with form=. Instead
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>//   we set attributes (step 8) out of order, after this step,
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#177500>//   to reset the form association.
</span></span></span><span style=display:flex><span><span style=color:#177500></span>      <span style=color:#000>form_associated_element</span><span style=color:#000>-&gt;</span><span style=color:#000>AssociateWith</span>(<span style=color:#000>form_</span>.<span style=color:#000>Get</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#177500>// &#34;8. Append each attribute in the given token to element.&#34;
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>SetAttributes</span>(<span style=color:#000>element</span>, <span style=color:#000>token</span>, <span style=color:#000>parser_content_policy_</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>return</span> <span style=color:#000>element</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></p></div><div class="admonition warning"><p class="first admonition-title">Warning</p><p>待完善对 createElement 的规范讲解。</p></div><p>创建 Element 的流程比较复杂，因为<a href=https://html.spec.whatwg.org/C/#create-an-element-for-the-token>规范</a>相当繁琐，我们这里直接看堆栈:</p><pre tabindex=0><code>#0	0x00000002d09b0ea4 in blink::HTMLDivElement::HTMLDivElement(blink::Document&amp;) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/html_div_element.cc:32
#1	0x00000002d0129ee4 in blink::HTMLDivElement* cppgc::MakeGarbageCollectedTrait&lt;blink::HTMLDivElement&gt;::Call&lt;blink::Document&amp;&gt;(cppgc::AllocationHandle&amp;, blink::Document&amp;) at /Users/airing/Files/code/chromium/src/v8/include/cppgc/allocation.h:242
#2	0x00000002d0125100 in blink::HTMLDivElement* cppgc::MakeGarbageCollected&lt;blink::HTMLDivElement, blink::Document&amp;&gt;(cppgc::AllocationHandle&amp;, blink::Document&amp;) [inlined] at /Users/airing/Files/code/chromium/src/v8/include/cppgc/allocation.h:280
#3	0x00000002d01250f0 in blink::HTMLDivElement* blink::MakeGarbageCollected&lt;blink::HTMLDivElement, blink::Document&amp;&gt;(blink::Document&amp;) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/platform/heap/garbage_collected.h:34
#4	0x00000002d21a16f8 in blink::HTMLDivConstructor(blink::Document&amp;, blink::CreateElementFlags) at /Users/airing/Files/code/chromium/src/out/gn/gen/third_party/blink/renderer/core/html_element_factory.cc:259
#5	0x00000002d219fdbc in blink::HTMLElementFactory::Create(WTF::AtomicString const&amp;, blink::Document&amp;, blink::CreateElementFlags) at /Users/airing/Files/code/chromium/src/out/gn/gen/third_party/blink/renderer/core/html_element_factory.cc:851
#6	0x00000002d22021c8 in blink::Document::CreateRawElement(blink::QualifiedName const&amp;, blink::CreateElementFlags) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/dom/document.cc:1031
#7	0x00000002d2337cf0 in blink::Element* blink::CustomElement::CreateUncustomizedOrUndefinedElementTemplate&lt;(blink::CustomElement::CreateUUCheckLevel)0&gt;(blink::Document&amp;, blink::QualifiedName const&amp;, blink::CreateElementFlags, WTF::AtomicString const&amp;) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/custom/custom_element.cc:158
#8	0x00000002d2337c68 in blink::CustomElement::CreateUncustomizedOrUndefinedElement(blink::Document&amp;, blink::QualifiedName const&amp;, blink::CreateElementFlags, WTF::AtomicString const&amp;) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/custom/custom_element.cc:180
#9	0x00000002d2367774 in blink::HTMLConstructionSite::CreateElement(blink::AtomicHTMLToken*, WTF::AtomicString const&amp;) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/parser/html_construction_site.cc:988
#10	0x00000002d2368230 in blink::HTMLConstructionSite::InsertHTMLElement(blink::AtomicHTMLToken*) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/parser/html_construction_site.cc:729
#11	0x00000002d23e28a8 in blink::HTMLTreeBuilder::ProcessStartTagForInBody(blink::AtomicHTMLToken*) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/parser/html_tree_builder.cc:648
#12	0x00000002d23dced0 in blink::HTMLTreeBuilder::ProcessStartTag(blink::AtomicHTMLToken*) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/parser/html_tree_builder.cc:1209
#13	0x00000002d23dc10c in blink::HTMLTreeBuilder::ProcessToken(blink::AtomicHTMLToken*) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/parser/html_tree_builder.cc:372
#14	0x00000002d23dadc8 in blink::HTMLTreeBuilder::ConstructTree(blink::AtomicHTMLToken*) at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/parser/html_tree_builder.cc:329
#15	0x00000002d237eff0 in blink::HTMLDocumentParser::ConstructTreeFromHTMLToken() at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/parser/html_document_parser.cc:954
#16	0x00000002d237d3a0 in blink::HTMLDocumentParser::PumpTokenizer() at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/parser/html_document_parser.cc:837
#17	0x00000002d237b734 in blink::HTMLDocumentParser::PumpTokenizerIfPossible() at /Users/airing/Files/code/chromium/src/third_party/blink/renderer/core/html/parser/html_document_parser.cc:703
</code></pre><p>可以发现这里层层调用，最后到 <code>HTMLElementFactory::Create</code> 的工厂方法里去找 <code>&lt;div></code> 映射对应的 <code>HTMLDivConstructor</code> 去构造 <code>&lt;div></code>。构造器处理了 GC 逻辑，并处理了 <code>&lt;div></code> 部分行内样式的绑定。</p><p><code>HTMLElementStack</code> 对象的栈结构如下所示:</p><figure><img src=/images/chromium-rendering-pipeline/open_elements.png alt=/images/chromium-rendering-pipeline/open_elements.png><figcaption><p>Figure: open_elements_</p></figcaption></figure><p style=position:relative><span class=aside>为保证健壮性，这里也会异常情况做自闭合处理。</span></p><p>最后看看 <code>&lt;/div></code> 的出栈，根据下述源码可见，这个时候会调用 <code>HTMLConstructionSite::OpenElements</code> 获取缓存的 <code>HTMLElementStack</code> 对象，并将 <code>&lt;div></code> 组合出栈。</p><p style=position:relative><span class=aside>该源码对应的规范可见: <a href="https://html.spec.whatwg.org/multipage/parsing.html#:~:text=An%20end%20tag%20whose%20tag%20name%20is%20one%20of%3A%20%22address%22%2C">https://html.spec.whatwg.org/multipage/parsing.html</a></span></p><div class="admonition sourcecode"><p class="first admonition-title">Source Code</p><p><p>HTMLTreeBuilder::ProcessEndTagForInBody</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#a90d91>void</span> <span style=color:#000>HTMLTreeBuilder</span><span style=color:#000>::</span><span style=color:#000>ProcessEndTagForInBody</span>(<span style=color:#000>AtomicHTMLToken</span><span style=color:#000>*</span> <span style=color:#000>token</span>) {
</span></span><span style=display:flex><span>  <span style=color:#177500>// ...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#a90d91>if</span> (<span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kAddressTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kArticleTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kAsideTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kBlockquoteTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kButtonTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kCenterTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kDetailsTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kDialogTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kDirTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kDivTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kDlTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kFieldsetTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kFigcaptionTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kFigureTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kFooterTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kHeaderTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kHgroupTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kListingTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kMainTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kMenuTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kNavTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kOlTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kPreTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kSectionTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kSummaryTag</span> <span style=color:#000>||</span>
</span></span><span style=display:flex><span>      <span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>() <span style=color:#000>==</span> <span style=color:#000>html_names</span><span style=color:#000>::</span><span style=color:#000>kUlTag</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> (<span style=color:#000>!</span><span style=color:#000>tree_</span>.<span style=color:#000>OpenElements</span>()<span style=color:#000>-&gt;</span><span style=color:#000>InScope</span>(<span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>())) {
</span></span><span style=display:flex><span>      <span style=color:#000>ParseError</span>(<span style=color:#000>token</span>);
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#000>tree_</span>.<span style=color:#000>GenerateImpliedEndTags</span>();
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> (<span style=color:#000>!</span><span style=color:#000>tree_</span>.<span style=color:#000>CurrentStackItem</span>()<span style=color:#000>-&gt;</span><span style=color:#000>MatchesHTMLTag</span>(<span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>()))
</span></span><span style=display:flex><span>      <span style=color:#000>ParseError</span>(<span style=color:#000>token</span>);
</span></span><span style=display:flex><span>    <span style=color:#000>tree_</span>.<span style=color:#000>OpenElements</span>()<span style=color:#000>-&gt;</span><span style=color:#000>PopUntilPopped</span>(<span style=color:#000>token</span><span style=color:#000>-&gt;</span><span style=color:#000>GetName</span>());
</span></span><span style=display:flex><span>    <span style=color:#a90d91>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#177500>// ...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>}
</span></span></code></pre></div></p></div><p>至此 Lexing 环节结束，后续流程会基于该环节存储 Element 使用到的数据结构来进行 DOM Tree 的构建。</p><p style=position:relative><span class=aside>DOM Construction: Element → DOM Tree</span></p><h2 id=dom-construction>DOM Construction</h2><p>DOM Tree 构建流程如下图所示：</p><figure><img src=/images/chromium-rendering-pipeline/parsing.png alt=/images/chromium-rendering-pipeline/parsing.png><figcaption><p>Figure: DOM Construction</p></figcaption></figure><p>Element 在创建时会 attach 到 <code>HTMLConstructionSite</code> 的成员变量 <code>_document</code> (<code>blink::Document</code>) 上，得益于 Element 数据结构的设计，当 HTML 文档所有 bytes 通过以上流程解析结束时，会得到一个完整 <code>_document</code> 对象，其中的 Tree 结构就是 DOM Tree。</p><figure><img src=/images/chromium-rendering-pipeline/dom-tree.png alt=/images/chromium-rendering-pipeline/dom-tree.png><figcaption><p>Figure: blink::Document</p></figcaption></figure><p style=position:relative><span class=aside>Element 数据结构在前文介绍 <code>HTMLElementStack</code> 时有断点截图，可自行翻阅前文查看。</span></p><div class="admonition sourcecode"><p class="first admonition-title">Node Tree</p><p><p>Node Tree 结构如下图所示</p><p><img src=/images/chromium-rendering-pipeline/next-sibling.svg alt></p><p>Node 是所有 node tree 最基础的数据结构（DOM Tree, CSSOM Tree, etc.，每个 Node 至少有以下三个指针：</p><ol><li>parent_or_shadow_host_node_: 指向父节点 (但如果是 shadow root 会指向 shadow host)</li><li>previous_: 指向上一个兄弟节点</li><li>next_: 指向下一个兄弟节点</li></ol><p>每个 Element 都集成自 ContainerNode, 而 ContainerNode 还有额外的两个指针：</p><ul><li>first_child_</li><li>last_child_</li></ul><p>兄弟节点是相互关联的，但这个结构意味着从父节点去寻找任意一个子节点需要 O(N) 复杂度。</p></p></div><p>至此，渲染管线的第一阶段 <code>Parsing</code> 已经完成，完善本节的具体流程，我们得到更完整的渲染管线结构图：</p><figure><img src=/images/chromium-rendering-pipeline/pipeline-1.png alt=/images/chromium-rendering-pipeline/pipeline-1.png><figcaption><p>Figure: Rendering Pipeline</p></figcaption></figure><h2 id=cssom-construction>CSSOM Construction</h2><div class="admonition warning"><p class="first admonition-title">Warning</p><p>This section will be written next.</p></div><h2 id=appendix-mojo>[Appendix] Mojo</h2><div class="admonition warning"><p class="first admonition-title">Warning</p><p>这里插播简单介绍一下 Mojo，后续丰富内容之后会独立成篇具体介绍 Mojo。</p></div><p style=position:relative><span class=aside>Mojo 也被用于 ChromeOS。</span></p><p>Mojo 是一个平台无关的跨平台 IPC 框架，在 Chromium 项目中用来实现 chromium 进程内/进程间的通信。</p><p>Mojo 的分层如下图所示：</p><figure><img src=/images/chromium-rendering-pipeline/mojo-overview.png alt=/images/chromium-rendering-pipeline/mojo-overview.png><figcaption><p>Figure: Mojo</p></figcaption></figure><ol><li>Mojo Core: Mojo 的实现层，不能独立使用，由 C++ 实现；</li><li>Mojo System API(C): Mojo 的 C API 层，它和 Mojo Core 对接，可以在程序中独立使用；</li><li>Mojo System API(C++/Java/JS): Mojo 的各种语言包装层，它将 Mojo C API 包装成多种语言的库，让其他语言可以使用。这一层也可以在程序中独立使用；</li><li>Mojo Bindings: 这一层引入一种称为 Mojom 的 IDL（接口定义）语言，通过它可以定义通信接口，这些接口会生成接口类，使用户只要实现这些接口就可以使用 Mojo 进行通信，这一层使得IPC两端不需要通过原始字节流进行通信，而是通过接口进行通信，有点类似 Protobuf 和 Thrift 。</li></ol><div class="admonition sourcecode"><p class="first admonition-title">Note</p><p><p>在 Chromium 中，还有两个基础模块使用 Mojo，分别是 Services 和 IPC::Channel。因此 Chromium 中 Mojo 完整的架构图如下所示：</p><p><img src=/images/chromium-rendering-pipeline/chromium-mojo-layer.png alt></p></p></div><p style=position:relative><span class=aside>这点类似 TCP/IP 中的 IP 地址和端口的关系。</span></p><p>Mojo 支持在多个进程之间互相通信，由 Mojo 组成的这些可以互相通信的进程形成了一个网络，在这个网络内的任意两个进程都可以进行通信，并且每个进程只能处于一个 Mojo 网络中，在这个网络内每一个进程内部有且只有一个 Node，每一个 Node 可以提供多个 Port，每个 Port 对应一种服务，一个 Node:Port 对可以唯一确定一个服务。</p><p><code>Node</code> 和 <code>Node</code> 之间通过 <code>Channel</code> 来实现通信，在不同平台上 <code>Channel</code> 有不同的实现方式</p><ul><li>在 Linux上 是 domain socket</li><li>在 windows 上是 name pipe</li><li>在 Mac OS 平台上是 Mach Port</li></ul><figure><img src=/images/chromium-rendering-pipeline/mojo-data-flow.png alt=/images/chromium-rendering-pipeline/mojo-data-flow.png><figcaption><p>Figure: Mojo</p></figcaption></figure><p style=position:relative><span class=aside>类似在 TCP 上封装了 HTTP，SMTP，FTP。</span></p><p>在 Port 上一层，Mojo 封装了 3 个“应用层协议”，分别为：</p><ol><li><code>MessagePipe</code>: 应用层接口，用于进程间的双向通信，类似 UDP，消息是基于数据报的，底层使用 Channel 通道</li><li><code>DataPipe</code>: 应用层接口，用于进程间单向块数据传递，类似 TCP，消息是基于数据流的，底层使用系统的 Shared Memory 实现</li><li><code>SharedBuffer</code>: 应用层接口，支持双向块数据传递，底层使用系统 Shared Memory 实现。</li></ol><div class="admonition sourcecode"><p class="first admonition-title">Source to read</p><p>你可以阅读官方文档 <a href=https://chromium.googlesource.com/chromium/src/+/master/mojo/README.md>Mojo docs (go/mojo-docs)</a> 以了解更多关于 Mojo 的内容。</p></div><div class="admonition tryit"><p class="first admonition-title">Create a new message pipe</p><p><p>有两种方式创建 <code>MessagePipe</code>，可以直接使用构造函数：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>mojo</span><span style=color:#000>::</span><span style=color:#000>MessagePipe</span> <span style=color:#000>pipe</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>// NOTE: Because pipes are bi-directional there is no implicit semantic
</span></span></span><span style=display:flex><span><span style=color:#177500>// difference between |handle0| or |handle1| here. They&#39;re just two ends of a
</span></span></span><span style=display:flex><span><span style=color:#177500>// pipe. The choice to treat one as a &#34;client&#34; and one as a &#34;server&#34; is entirely
</span></span></span><span style=display:flex><span><span style=color:#177500>// the API user&#39;s decision.
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>mojo</span><span style=color:#000>::</span><span style=color:#000>ScopedMessagePipeHandle</span> <span style=color:#000>client</span> <span style=color:#000>=</span> <span style=color:#000>std</span><span style=color:#000>::</span><span style=color:#000>move</span>(<span style=color:#000>pipe</span>.<span style=color:#000>handle0</span>);
</span></span><span style=display:flex><span><span style=color:#000>mojo</span><span style=color:#000>::</span><span style=color:#000>ScopedMessagePipeHandle</span> <span style=color:#000>server</span> <span style=color:#000>=</span> <span style=color:#000>std</span><span style=color:#000>::</span><span style=color:#000>move</span>(<span style=color:#000>pipe</span>.<span style=color:#000>handle1</span>);
</span></span></code></pre></div><p>或者调用 <code>CreateMessagePipe</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>mojo</span><span style=color:#000>::</span><span style=color:#000>ScopedMessagePipeHandle</span> <span style=color:#000>client</span>;
</span></span><span style=display:flex><span><span style=color:#000>mojo</span><span style=color:#000>::</span><span style=color:#000>ScopedMessagePipeHandle</span> <span style=color:#000>server</span>;
</span></span><span style=display:flex><span><span style=color:#000>mojo</span><span style=color:#000>::</span><span style=color:#000>CreateMessagePipe</span>(<span style=color:#a90d91>nullptr</span>, <span style=color:#000>&amp;</span><span style=color:#000>client</span>, <span style=color:#000>&amp;</span><span style=color:#000>server</span>);
</span></span></code></pre></div></p></div><div class="admonition tryit"><p class="first admonition-title">Create a new data pipe</p><p><p>同创建 Message Pipe 类似，也有两种方式：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>mojo</span><span style=color:#000>::</span><span style=color:#000>DataPipe</span> <span style=color:#000>pipe</span>;
</span></span><span style=display:flex><span><span style=color:#000>mojo</span><span style=color:#000>::</span><span style=color:#000>ScopedDataPipeProducerHandle</span> <span style=color:#000>producer</span> <span style=color:#000>=</span> <span style=color:#000>std</span><span style=color:#000>::</span><span style=color:#000>move</span>(<span style=color:#000>pipe</span>.<span style=color:#000>producer_handle</span>);
</span></span><span style=display:flex><span><span style=color:#000>mojo</span><span style=color:#000>::</span><span style=color:#000>ScopedDataPipeConsumerHandle</span> <span style=color:#000>consumer</span> <span style=color:#000>=</span> <span style=color:#000>std</span><span style=color:#000>::</span><span style=color:#000>move</span>(<span style=color:#000>pipe</span>.<span style=color:#000>consumer_handle</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>// Or alternatively:
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>mojo</span><span style=color:#000>::</span><span style=color:#000>ScopedDataPipeProducerHandle</span> <span style=color:#000>producer</span>;
</span></span><span style=display:flex><span><span style=color:#000>mojo</span><span style=color:#000>::</span><span style=color:#000>ScopedDataPipeConsumerHandle</span> <span style=color:#000>consumer</span>;
</span></span><span style=display:flex><span><span style=color:#000>mojo</span><span style=color:#000>::</span><span style=color:#000>CreateDataPipe</span>(<span style=color:#a90d91>nullptr</span>, <span style=color:#000>producer</span>, <span style=color:#000>consumer</span>);
</span></span></code></pre></div></p></div><div class="admonition tryit"><p class="first admonition-title">Create a new shared buffer</p><p><p>创建 Shared buffer 方法如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>mojo</span><span style=color:#000>::</span><span style=color:#000>ScopedSharedBufferHandle</span> <span style=color:#000>buffer</span> <span style=color:#000>=</span>
</span></span><span style=display:flex><span>    <span style=color:#000>mojo</span><span style=color:#000>::</span><span style=color:#000>SharedBufferHandle</span><span style=color:#000>::</span><span style=color:#000>Create</span>(<span style=color:#1c01ce>4096</span>);
</span></span></code></pre></div><p>这个 handle 可以被任意 <code>Clone</code> 多次:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>mojo</span><span style=color:#000>::</span><span style=color:#000>ScopedSharedBufferHandle</span> <span style=color:#000>another_handle</span> <span style=color:#000>=</span> <span style=color:#000>buffer</span><span style=color:#000>-&gt;</span><span style=color:#000>Clone</span>();
</span></span><span style=display:flex><span><span style=color:#000>mojo</span><span style=color:#000>::</span><span style=color:#000>ScopedSharedBufferHandle</span> <span style=color:#000>read_only_handle</span> <span style=color:#000>=</span>
</span></span><span style=display:flex><span>    <span style=color:#000>buffer</span><span style=color:#000>-&gt;</span><span style=color:#000>Clone</span>(<span style=color:#000>mojo</span><span style=color:#000>::</span><span style=color:#000>SharedBufferHandle</span><span style=color:#000>::</span><span style=color:#000>AccessMode</span><span style=color:#000>::</span><span style=color:#000>READ_ONLY</span>);
</span></span></code></pre></div></p></div><h2 id=resources>Resources</h2><ul><li><a href=https://developer.chrome.com/blog/inside-browser-part3/>Inside look at modern web browser (part 3)</a></li><li><a href="https://docs.google.com/presentation/d/1boPxbgNrTU0ddsc144rcXayGA_WF53k96imRH8Mp34Y/edit#slide=id.ga884fe665f_64_45">Life of a pixel - Google Docs</a></li><li><a href=https://chromium.googlesource.com/chromium/src/+/master/mojo/README.md>Mojo docs (go/mojo-docs)</a></li></ul><div class="admonition warning"><p class="first admonition-title">Warning</p><p><p>TODO:</p><ol><li>补充 custom element 与 shadow tree</li><li>补充 flat tree traversal</li><li>补充 CSSOM Tree 的构建流程</li></ol></p></div></div><div class="row middle-xs"><div class=col-xs-12></div></div><div class=row><div class=col-xs-12><br><br><p>Subscribe <a target=_blank href=https://weekly.ursb.me/index.xml>Airing's Weekly</a></p><p>© 粤ICP备16057808号</p></div></div><div style=height:50px></div><div class=site-footer></div></div></div></article><script></script></body></html>